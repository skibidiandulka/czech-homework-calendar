<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalendář Úkolů</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Anthropic.com professional beige palette */
            --anthropic-coral: #d97757;
            --anthropic-coral-light: rgba(217, 119, 87, 0.08);
            --anthropic-coral-selection: rgba(204, 120, 92, 0.3);
            --anthropic-bg: #f8f6f0;
            --anthropic-card-bg: #ffffff;
            --anthropic-warm-white: #fefdfb;
            --anthropic-text: #2c2a26;
            --anthropic-text-secondary: #8b8680;
            --anthropic-text-muted: #b5b1a8;
            --anthropic-border: #e8e5de;
            --anthropic-border-light: #f0edea;
            --anthropic-shadow: rgba(44, 42, 38, 0.06);
            --anthropic-shadow-strong: rgba(44, 42, 38, 0.12);
            --border-radius: 12px;
            --small-radius: 6px;

            /* Event colors */
            --homework-color: #22c55e;
            --homework-light: rgba(34, 197, 94, 0.1);
            --test-color: #eab308;
            --test-light: rgba(234, 179, 8, 0.1);
            --other-color: #3b82f6;
            --other-light: rgba(59, 130, 246, 0.1);
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: var(--anthropic-bg);
            color: var(--anthropic-text);
            line-height: 1.5;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            letter-spacing: -0.01em;
        }

        /* Prevent background scrolling when modal is open */
        body.modal-open {
            overflow: hidden;
        }

        body, html {
            overflow-x: hidden;
        }

        /* Container */
        .calendar-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 96px 20px 20px; /* Extra top padding for fixed header */
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .calendar-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
            padding: 16px 8px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            gap: 32px;
            background: var(--anthropic-bg);
            z-index: 100;
            border-bottom: 1px solid var(--anthropic-border-light);
            box-shadow: 0 2px 8px var(--anthropic-shadow);
        }

        .hamburger-container {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 16px;
        }


        .hamburger-wrapper {
            position: relative;
            display: inline-block;
        }

        .month-title {
            font-family: 'Poppins', 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            font-size: 2.2rem;
            font-weight: 500;
            color: var(--anthropic-text);
            letter-spacing: -0.02em;
            min-width: 200px;
            text-align: center;
            text-transform: uppercase;
            font-variant: small-caps;
        }

        .nav-btn {
            background: var(--anthropic-warm-white);
            border: 1px solid var(--anthropic-border);
            border-radius: var(--small-radius);
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 500;
            color: var(--anthropic-text-secondary);
            transition: all 0.15s ease;
            box-shadow: 0 1px 3px var(--anthropic-shadow);
        }

        .nav-btn:hover {
            background: var(--anthropic-coral-light);
            border-color: var(--anthropic-coral);
            color: var(--anthropic-coral);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px var(--anthropic-shadow-strong);
        }

        /* Hamburger Menu */
        .hamburger-btn {
            background: var(--anthropic-warm-white);
            border: 1px solid var(--anthropic-border);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px var(--anthropic-shadow);
            position: relative;
            overflow: hidden;
        }

        .hamburger-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--anthropic-coral-light);
            border-radius: 50%;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translate(-50%, -50%);
            z-index: 0;
        }

        .hamburger-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px var(--anthropic-shadow-strong);
            border-color: var(--anthropic-coral);
        }

        .hamburger-btn:hover::before {
            width: 100%;
            height: 100%;
        }

        .hamburger-btn:active {
            transform: translateY(0) scale(0.95);
        }

        .hamburger-line {
            width: 20px;
            height: 2px;
            background: var(--anthropic-text-secondary);
            border-radius: 2px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
        }

        .hamburger-btn:hover .hamburger-line {
            background: var(--anthropic-coral);
            transform: scale(1.1);
        }

        .hamburger-btn.active .hamburger-line:nth-child(1) {
            transform: translateY(5px) rotate(45deg);
        }

        .hamburger-btn.active .hamburger-line:nth-child(2) {
            opacity: 0;
            transform: scale(0);
        }

        .hamburger-btn.active .hamburger-line:nth-child(3) {
            transform: translateY(-5px) rotate(-45deg);
        }

        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--anthropic-card-bg);
            border: 1px solid var(--anthropic-border);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px var(--anthropic-shadow-strong);
            transform-origin: top right;
            transform: scale(0);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            min-width: 220px;
            margin-top: 8px;
            padding: 12px;
        }

        .dropdown-menu.show {
            transform: scale(1);
            opacity: 1;
            visibility: visible;
        }

        .dropdown-menu::before {
            content: '';
            position: absolute;
            top: -6px;
            right: 12px;
            width: 12px;
            height: 12px;
            background: var(--anthropic-card-bg);
            border: 1px solid var(--anthropic-border);
            border-bottom: none;
            border-right: none;
            transform: rotate(45deg);
        }

        .menu-item {
            display: block;
            width: 100%;
            padding: 14px 16px;
            background: var(--anthropic-warm-white);
            border: 1px solid var(--anthropic-border-light);
            border-radius: var(--small-radius);
            color: var(--anthropic-text);
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
            margin-bottom: 8px;
        }

        .menu-item:last-child {
            margin-bottom: 0;
        }

        .menu-item:hover {
            background: var(--anthropic-coral-light);
            border-color: var(--anthropic-coral);
            color: var(--anthropic-coral);
            transform: translateY(-1px);
        }

        .menu-item.logout {
            color: #dc3545;
            border-color: rgba(220, 53, 69, 0.2);
            background: rgba(220, 53, 69, 0.05);
        }

        .menu-item.logout:hover {
            background: rgba(220, 53, 69, 0.1);
            border-color: #dc3545;
            color: #dc3545;
        }

        .menu-separator {
            height: 1px;
            background: var(--anthropic-border-light);
            margin: 8px 0;
        }

        .menu-item.blocked {
            background: var(--anthropic-border-light);
            color: var(--anthropic-text-muted);
            border-color: var(--anthropic-border-light);
            cursor: not-allowed;
            position: relative;
            overflow: hidden;
        }

        .menu-item.blocked:hover {
            background: var(--anthropic-border-light);
            color: var(--anthropic-text-muted);
            border-color: var(--anthropic-border-light);
            transform: none;
        }

        .menu-item.blocked::after {
            content: "TENTO ÚČET JE ZABLOKOVÁN";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        /* Login Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(44, 42, 38, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 2000;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px 0;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-overlay.hiding {
            opacity: 0;
            visibility: visible;
        }

        .modal {
            background: var(--anthropic-card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 16px 64px var(--anthropic-shadow-strong);
            padding: 32px;
            width: 90%;
            max-width: 400px;
            max-height: 85vh;
            overflow-y: auto;
            overflow-x: hidden;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: auto;
        }

        .modal-overlay.show .modal {
            transform: scale(1) translateY(0);
        }

        .modal-overlay.hiding .modal {
            transform: scale(0.9) translateY(20px);
        }

        .modal-header {
            margin-bottom: 24px;
            text-align: center;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 32px;
            height: 32px;
            background: var(--anthropic-warm-white);
            border: 1px solid var(--anthropic-border);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 500;
            color: var(--anthropic-text-secondary);
            transition: all 0.15s ease;
            box-shadow: 0 2px 8px var(--anthropic-shadow);
        }

        .modal-close:hover {
            background: rgba(220, 53, 69, 0.1);
            border-color: #dc3545;
            color: #dc3545;
            transform: scale(1.1);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--anthropic-text);
            margin-bottom: 8px;
        }

        .modal-subtitle {
            color: var(--anthropic-text-secondary);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--anthropic-text);
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--anthropic-border);
            border-radius: var(--small-radius);
            font-size: 14px;
            font-family: inherit;
            background: var(--anthropic-warm-white);
            color: var(--anthropic-text);
            transition: all 0.15s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--anthropic-coral);
            box-shadow: 0 0 0 3px var(--anthropic-coral-light);
        }

        /* Fix date input width - slightly narrower than other inputs */
        input[type="date"].form-input {
            width: 90%;
            box-sizing: border-box;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--anthropic-coral);
        }

        .checkbox-group label {
            font-size: 14px;
            color: var(--anthropic-text-secondary);
            cursor: pointer;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 24px;
            border-radius: var(--small-radius);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
            font-family: inherit;
        }

        .btn-secondary {
            background: var(--anthropic-warm-white);
            color: var(--anthropic-text-secondary);
            border: 1px solid var(--anthropic-border);
        }

        .btn-secondary:hover {
            background: var(--anthropic-border-light);
            color: var(--anthropic-text);
        }

        .btn-primary {
            background: var(--anthropic-coral);
            color: white;
            border: 1px solid var(--anthropic-coral);
        }

        .btn-primary:hover {
            background: #c15946;
            transform: translateY(-1px);
        }

        /* User Management Styles */
        .user-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--anthropic-warm-white);
            border: 1px solid var(--anthropic-border-light);
            border-radius: var(--small-radius);
            margin-bottom: 8px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-name {
            font-weight: 600;
            color: var(--anthropic-text);
        }

        .user-tier {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .user-tier.admin {
            background: var(--anthropic-coral-light);
            color: var(--anthropic-coral);
        }

        .user-tier.basic {
            background: var(--anthropic-border-light);
            color: var(--anthropic-text-secondary);
        }

        .user-tier.blocked {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: var(--small-radius);
            border: 1px solid var(--anthropic-border);
            background: var(--anthropic-warm-white);
            color: var(--anthropic-text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-small:hover {
            background: var(--anthropic-coral-light);
            border-color: var(--anthropic-coral);
            color: var(--anthropic-coral);
        }

        /* File Upload Styles */
        .file-upload-area {
            border: 2px dashed var(--anthropic-border);
            border-radius: var(--small-radius);
            padding: 20px;
            text-align: center;
            background: var(--anthropic-warm-white);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .file-upload-area:hover {
            border-color: var(--anthropic-coral);
            background: var(--anthropic-coral-light);
        }

        .file-upload-area.dragover {
            border-color: var(--anthropic-coral);
            background: var(--anthropic-coral-light);
        }

        .file-upload-text {
            color: var(--anthropic-text-secondary);
            font-size: 14px;
        }

        .file-selected {
            margin-top: 8px;
            padding: 8px 12px;
            background: var(--anthropic-coral-light);
            border-radius: var(--small-radius);
            color: var(--anthropic-coral);
            font-size: 13px;
            font-weight: 500;
        }

        /* Desktop Calendar (Vertical Day List) */
        .calendar-desktop {
            display: block;
        }

        .calendar-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 0;
        }

        .day-card {
            background: var(--anthropic-card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 12px var(--anthropic-shadow);
            padding: 20px;
            transition: all 0.2s ease;
            border: 1px solid var(--anthropic-border-light);
            position: relative;
        }

        .day-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px var(--anthropic-shadow-strong);
        }

        .day-card.today {
            background: linear-gradient(135deg, var(--anthropic-coral-light), var(--anthropic-card-bg));
            border-color: var(--anthropic-coral);
            box-shadow: 0 4px 24px var(--anthropic-coral-selection);
        }

        .day-card.today::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--anthropic-coral), #c15946);
            border-radius: 12px 12px 0 0;
        }

        .day-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--anthropic-border-light);
        }

        .day-card.today .day-card-header {
            border-bottom-color: rgba(217, 119, 87, 0.2);
        }

        .day-card-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .day-card-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--anthropic-text);
            line-height: 1;
        }

        .day-card.today .day-card-number {
            color: var(--anthropic-coral);
            font-weight: 800;
        }

        .day-card-name {
            font-size: 14px;
            color: var(--anthropic-text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .day-card.today .day-card-name {
            color: var(--anthropic-coral);
            font-weight: 600;
        }

        .day-card-badge {
            background: var(--anthropic-coral);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .day-card-events {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .day-card-empty {
            text-align: center;
            color: var(--anthropic-text-muted);
            font-style: italic;
            padding: 16px;
            font-size: 14px;
            background: var(--anthropic-border-light);
            border-radius: 8px;
        }

        .day-card.today .day-card-empty {
            background: rgba(217, 119, 87, 0.1);
            color: var(--anthropic-coral);
            font-style: normal;
            font-weight: 500;
        }

        .event-item {
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid;
            background: var(--anthropic-warm-white);
            color: var(--anthropic-text);
            line-height: 1.4;
        }

        .event-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px var(--anthropic-shadow);
        }

        .event-item.homework {
            border-color: var(--homework-color);
            background: var(--homework-light);
        }

        .event-item.test {
            border-color: var(--test-color);
            background: var(--test-light);
        }

        .event-item.other {
            border-color: var(--other-color);
            background: var(--other-light);
        }

        /* Month separator */
        .month-separator {
            display: flex;
            align-items: center;
            margin: 32px 0 24px 0;
            gap: 16px;
        }

        .separator-line {
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--anthropic-border), transparent);
        }

        .separator-text {
            color: var(--anthropic-text-secondary);
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0 12px;
            background: var(--anthropic-bg);
        }

        /* Next month days styling */
        .day-card.next-month {
            opacity: 0.85;
            background: var(--anthropic-warm-white);
        }

        .day-card.next-month:hover {
            opacity: 1;
            background: var(--anthropic-card-bg);
        }

        .day-card.next-month .day-card-number {
            color: var(--anthropic-text-secondary);
        }

        .day-card.next-month .day-card-name {
            color: var(--anthropic-text-muted);
        }

        /* Responsive Design */
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .calendar-container {
                padding: 80px 8px 12px;
            }

            .calendar-header {
                padding: 12px 8px;
                gap: 12px;
                margin-bottom: 16px;
            }

            .month-title {
                font-size: 1.5rem;
                min-width: 100px;
            }

            .nav-btn {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            .hamburger-btn {
                width: 36px;
                height: 36px;
            }

            .calendar-grid {
                gap: 12px;
            }

            .day-card {
                padding: 16px;
                border-radius: 10px;
            }

            .day-card-number {
                font-size: 1.6rem;
            }

            .day-card-name {
                font-size: 13px;
            }

            .day-card-badge {
                padding: 3px 10px;
                font-size: 10px;
            }

            .event-item {
                padding: 8px 12px;
                font-size: 13px;
            }

            .month-separator {
                margin: 24px 0 16px 0;
                gap: 12px;
            }

            .separator-text {
                font-size: 14px;
                padding: 0 8px;
            }

            /* Modal adjustments for mobile */
            .modal {
                padding: 20px;
                width: 92%;
                max-width: none;
                max-height: 80vh;
            }

            .modal-overlay {
                padding: 10px 0;
            }

            .form-input, .btn {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }

        @media (max-width: 480px) {
            .calendar-container {
                padding: 76px 4px 8px;
            }

            .calendar-header {
                padding: 10px 4px;
                gap: 8px;
            }

            .month-title {
                font-size: 1.3rem;
                min-width: 90px;
            }

            .nav-btn {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }

            .hamburger-btn {
                width: 32px;
                height: 32px;
            }

            .hamburger-container {
                right: 8px;
            }

            .calendar-grid {
                gap: 10px;
            }

            .day-card {
                padding: 14px;
                border-radius: 8px;
            }

            .day-card-number {
                font-size: 1.4rem;
            }

            .day-card-name {
                font-size: 12px;
            }

            .day-card-badge {
                padding: 3px 8px;
                font-size: 9px;
            }

            .event-item {
                padding: 6px 10px;
                font-size: 12px;
            }

            .month-separator {
                margin: 20px 0 12px 0;
                gap: 10px;
            }

            .separator-text {
                font-size: 12px;
                padding: 0 6px;
            }

            .modal {
                padding: 16px;
                width: 95%;
                max-height: 85vh;
            }

            .modal-overlay {
                padding: 8px 0;
            }
        }

        /* Toast notification for background uploads */
        .upload-toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--anthropic-card-bg);
            border: 1px solid var(--anthropic-border);
            border-radius: var(--border-radius);
            padding: 16px 20px;
            box-shadow: 0 4px 16px var(--anthropic-shadow-strong);
            z-index: 10000;
            display: none;
            max-width: 320px;
            animation: slideInUp 0.3s ease-out;
        }

        .upload-toast.show {
            display: block;
        }

        .upload-toast-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .upload-toast-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid var(--anthropic-border);
            border-top-color: var(--anthropic-coral);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .upload-toast-text {
            font-size: 14px;
            color: var(--anthropic-text);
            font-weight: 500;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .upload-toast {
                bottom: 16px;
                right: 16px;
                left: 16px;
                max-width: none;
            }
        }

        /* Today scroll button */
        .today-scroll-btn {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 56px;
            height: 56px;
            background: var(--anthropic-coral);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 6px 24px var(--anthropic-shadow-strong);
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
            z-index: 1500;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .today-scroll-btn.show {
            opacity: 1;
            visibility: visible;
        }

        .today-scroll-btn:hover {
            background: #c15946;
            transform: scale(1.1);
            box-shadow: 0 8px 32px var(--anthropic-shadow-strong);
        }

        .today-scroll-btn:active {
            transform: scale(0.95);
        }

        @media (max-width: 768px) {
            .today-scroll-btn {
                bottom: 24px;
                right: 24px;
                width: 48px;
                height: 48px;
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .today-scroll-btn {
                bottom: 20px;
                right: 20px;
                width: 44px;
                height: 44px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="calendar-container">
        <!-- Header -->
        <div class="calendar-header">
            <button class="nav-btn" onclick="previousMonth()">‹</button>
            <h1 class="month-title" id="monthTitle">Září 2025</h1>
            <button class="nav-btn" onclick="nextMonth()">›</button>
            <div class="hamburger-container">
                <div class="hamburger-wrapper">
                    <button class="hamburger-btn" onclick="toggleMenu()" id="hamburgerBtn">
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                    </button>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <button class="menu-item" onclick="openLogin()">Přihlásit se</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Desktop Calendar (Full Month) -->
        <div class="calendar-desktop" id="calendarDesktop">
            <div class="calendar-grid" id="calendarGrid">
                <!-- Desktop calendar will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Today Scroll Button -->
    <button class="today-scroll-btn" id="todayScrollBtn" onclick="scrollToToday()">↓</button>

    <!-- Login Modal -->
    <div class="modal-overlay" id="loginModal" onclick="closeModalOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeLoginModal()">×</button>
                <h2 class="modal-title">Přihlášení</h2>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label" for="username">Jméno</label>
                    <input type="text" id="username" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="password">Heslo</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="stayLoggedIn">
                    <label for="stayLoggedIn">Zůstat přihlášen</label>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">Přihlásit se</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal-overlay" id="addUserModal" onclick="closeModalOverlay(event, 'addUserModal')">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeAddUserModal()">×</button>
                <h2 class="modal-title">Přidat uživatele</h2>
            </div>
            <form onsubmit="handleAddUser(event)">
                <div class="form-group">
                    <label class="form-label" for="newUsername">Jméno</label>
                    <input type="text" id="newUsername" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="newPassword">Heslo</label>
                    <input type="password" id="newPassword" class="form-input" required>
                </div>
                <div style="font-size: 12px; color: var(--anthropic-text-secondary); margin-bottom: 16px; text-align: center;">
                    ⏱️ Uživatel se zobrazí v seznamu za 2-5 minut kvůli synchronizaci
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">Přidat</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manage Users Modal -->
    <div class="modal-overlay" id="manageUsersModal" onclick="closeModalOverlay(event, 'manageUsersModal')">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeManageUsersModal()">×</button>
                <h2 class="modal-title">Správa uživatelů</h2>
            </div>
            <div class="user-list" id="userList">
                <!-- Users will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div class="modal-overlay" id="eventModal" onclick="closeModalOverlay(event, 'eventModal')">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeEventModal()">×</button>
                <h2 class="modal-title" id="eventModalTitle">Přidat událost</h2>
            </div>
            <form onsubmit="handleAddEvent(event)">
                <div class="form-group">
                    <label class="form-label" for="eventName">Název *</label>
                    <input type="text" id="eventName" class="form-input" required>
                </div>
                <div class="form-group" id="subjectGroup" style="display: none;">
                    <label class="form-label" for="eventSubject">Předmět *</label>
                    <select id="eventSubject" class="form-input" required>
                        <option value="">Vyberte předmět</option>
                        <option value="ICT">ICT</option>
                        <option value="DĚJ">DĚJ</option>
                        <option value="FYZ">FYZ</option>
                        <option value="ŠPJ">ŠPJ</option>
                        <option value="CJL">CJL</option>
                        <option value="ANJ">ANJ</option>
                        <option value="BIO">BIO</option>
                        <option value="MAT">MAT</option>
                        <option value="ESW">ESW</option>
                        <option value="ZSV">ZSV</option>
                        <option value="ZEM">ZEM</option>
                        <option value="UaK">UaK</option>
                        <option value="BEN">BEN</option>
                        <option value="CHEM">CHEM</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="eventDate">Datum *</label>
                    <input type="date" id="eventDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="eventDescription">Popis</label>
                    <textarea id="eventDescription" class="form-input" rows="3" placeholder="Volitelný popis události..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Přílohy</label>
                    <div class="file-upload-area" onclick="document.getElementById('eventFile').click()" ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)">
                        <div class="file-upload-text">Klikněte nebo přetáhněte soubory</div>
                        <div class="file-upload-text" style="font-size: 12px; margin-top: 4px;">Podporované: obrázky, PDF, DOCX, PPTX</div>
                    </div>
                    <input type="file" id="eventFile" style="display: none;" accept="image/*,.pdf,.docx,.pptx" onchange="handleFileSelect(event)" multiple>
                    <div id="filesList" style="margin-top: 12px;"></div>
                </div>
                <div style="font-size: 12px; color: var(--anthropic-text-secondary); margin-bottom: 16px; text-align: center;">
                    ⏱️ Událost se zobrazí v kalendáři za 2-5 minut kvůli synchronizaci
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">Přidat</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Event Detail Modal -->
    <div class="modal-overlay" id="eventDetailModal" onclick="closeModalOverlay(event, 'eventDetailModal')">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeEventDetailModal()">×</button>
                <h2 class="modal-title" id="eventDetailTitle">Detail události</h2>
            </div>
            <div id="eventDetailContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentDate = new Date();
        let currentUser = null;
        let currentEventType = null;
        let selectedFiles = []; // Changed to array for multiple files
        let isEditMode = false;
        let editingEventId = null;
        let existingFiles = []; // Changed to array for multiple files
        let backgroundUploads = []; // Track background file uploads

        // GitHub shared data storage
        let events = {};
        let users = {};
        let isDataLoaded = false;
        let saveQueue = [];
        let isCurrentlySaving = false;

        // GitHub API configuration
        const GITHUB_REPO = 'skibidiandulka/czech-homework-calendar';
        const GITHUB_DATA_URL = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/data.json`;

        // Hidden token function to prevent F12 inspection
        let GITHUB_TOKEN = null;
        function getApiToken() {
            if (!GITHUB_TOKEN) {
                // Obfuscated token parts - harder to find in DevTools
                const a = 'ghp_v8eJ', b = 'xR71yooA', c = 'lX0ug4VW', d = 'cjE0oJWH', e = 'Ew3v2YtH';
                GITHUB_TOKEN = [a,b,c,d,e].join('');
            }
            return GITHUB_TOKEN;
        }

        async function loadDataFromDatabase() {
            try {
                console.log('Loading data from GitHub...');
                const response = await fetch(GITHUB_DATA_URL + '?cache=' + Date.now());
                const data = await response.json();

                events = data?.events || {};
                users = data?.users || {};

                // Convert old single file format to new multiple files format (backward compatibility)
                for (const date in events) {
                    events[date].forEach(event => {
                        // If event has old 'file' property (singular), convert to 'files' array
                        if (event.hasOwnProperty('file') && !event.hasOwnProperty('files')) {
                            if (event.file && event.file !== null) {
                                // Add unique ID if missing
                                if (!event.file.id) {
                                    event.file.id = event.file.name + '_' + Date.now();
                                }
                                event.files = [event.file];
                            } else {
                                event.files = [];
                            }
                            delete event.file; // Remove old property
                        }
                        // Ensure files is always an array
                        if (!event.files) {
                            event.files = [];
                        }
                    });
                }

                isDataLoaded = true;

                console.log('Data loaded successfully from GitHub:', { events, users });

                // Re-render calendar after data loads
                renderDesktopCalendar();

                return true;
            } catch (error) {
                console.error('Failed to load data from GitHub:', error);
                // Fallback to default admin user
                users = {
                    'admin': {
                        password: 'asdf',
                        name: 'Admin',
                        tier: 'admin'
                    }
                };
                events = {};
                isDataLoaded = true;
                return false;
            }
        }

        async function saveFileToGitHub(file, eventId) {
            try {
                const token = getApiToken();
                if (!token) return null;

                // Create file path in attachments folder
                const fileName = `${eventId}_${file.name}`;
                const filePath = `attachments/${fileName}`;

                // Convert data URL to base64 content only
                const base64Content = file.data.split(',')[1];

                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: `Add attachment: ${file.name}`,
                        content: base64Content
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ File uploaded to GitHub:', fileName);
                    return {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        githubPath: filePath,
                        downloadUrl: result.content.download_url
                    };
                } else {
                    console.log('⚠️ File upload failed:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('Failed to upload file:', error);
                return null;
            }
        }

        async function saveDataToDatabase() {
            try {
                // Check if online
                if (!navigator.onLine) {
                    console.log('📴 Device is offline, saving locally only');
                    const data = {
                        events,
                        users,
                        lastUpdated: new Date().toISOString()
                    };
                    localStorage.setItem('calendar_backup', JSON.stringify(data));
                    return true;
                }

                // Get token securely
                const token = getApiToken();
                if (!token) {
                    console.log('⚠️ No GitHub token available, saving locally only');
                    const data = {
                        events,
                        users,
                        lastUpdated: new Date().toISOString()
                    };
                    localStorage.setItem('calendar_backup', JSON.stringify(data));
                    return true;
                }

                console.log('🔄 Syncing data to GitHub...');
                const data = {
                    events,
                    users,
                    lastUpdated: new Date().toISOString()
                };

                // Get current file SHA first
                const sha = await getFileShaSafe();
                if (!sha) {
                    console.log('⚠️ Could not get file SHA, probably network issue. Saving locally only.');
                    localStorage.setItem('calendar_backup', JSON.stringify(data));
                    console.log('💾 Data saved locally as backup');
                    return true; // Don't fail, just save locally
                }

                // Update data.json via GitHub API
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/data.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: 'Auto-sync calendar data',
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))), // UTF-8 safe Base64 encode
                        sha: sha
                    })
                });

                if (response.ok) {
                    console.log('✅ Data automatically synced to GitHub');
                    return true;
                } else {
                    console.log('⚠️ GitHub API failed:', response.status);

                    // If unauthorized, clear token
                    if (response.status === 401 || response.status === 403) {
                        GITHUB_TOKEN = null;
                        console.log('❌ GitHub API unauthorized');
                    }

                    // Fallback to localStorage
                    localStorage.setItem('calendar_backup', JSON.stringify(data));
                    console.log('💾 Data saved locally as backup');
                    return true;
                }
            } catch (error) {
                console.error('Failed to save data to GitHub:', error);

                // Always save to localStorage as backup
                const data = {
                    events,
                    users,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('calendar_backup', JSON.stringify(data));

                console.log('💾 Data saved locally as backup');
                return false;
            }
        }

        async function getFileShaSafe(retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const token = getApiToken();
                    const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/data.json`, {
                        headers: {
                            'Authorization': `token ${token}`,
                        }
                    });
                    if (response.ok) {
                        const fileData = await response.json();
                        return fileData.sha;
                    } else {
                        console.log(`⚠️ Get SHA attempt ${i + 1} failed:`, response.status);
                        if (i === retries - 1) return null;
                    }
                } catch (error) {
                    console.log(`⚠️ Get SHA attempt ${i + 1} failed:`, error.message);
                    if (i === retries - 1) {
                        console.log('❌ All retry attempts failed, saving locally only');
                        return null;
                    }
                    // Wait before retry
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            return null;
        }

        // Auto-save functions - save immediately without user interaction
        async function autoSave() {
            return new Promise((resolve) => {
                // Add to queue
                saveQueue.push(resolve);

                // Process queue if not already processing
                if (!isCurrentlySaving) {
                    processSaveQueue();
                }
            });
        }

        async function processSaveQueue() {
            if (isCurrentlySaving || saveQueue.length === 0) {
                return;
            }

            isCurrentlySaving = true;
            console.log(`💾 Processing save queue (${saveQueue.length} items)`);

            // Timeout backup - if save takes too long, resolve anyway
            const timeoutId = setTimeout(() => {
                console.log('⏰ Save timeout - resolving queue anyway');
                const resolvers = [...saveQueue];
                saveQueue = [];
                resolvers.forEach(resolve => resolve());
                isCurrentlySaving = false;
            }, 90000); // 90 seconds timeout

            try {
                const success = await saveDataToDatabase();
                clearTimeout(timeoutId);

                // Don't reload - data is already current in memory
                // User can manually refresh or it will sync on next page load

                // Resolve all queued saves
                const resolvers = [...saveQueue];
                saveQueue = [];
                resolvers.forEach(resolve => resolve());

            } catch (error) {
                clearTimeout(timeoutId);
                console.log('Save queue failed, data saved locally as backup');
                // Still resolve the promises
                const resolvers = [...saveQueue];
                saveQueue = [];
                resolvers.forEach(resolve => resolve());
            }

            isCurrentlySaving = false;

            // Process next batch if queue has more items
            if (saveQueue.length > 0) {
                setTimeout(() => processSaveQueue(), 500); // Small delay between batches
            }
        }

        // Legacy function names - now auto-save
        function saveEvents() {
            autoSave();
            return true;
        }

        function saveUsers() {
            autoSave();
            return true;
        }

        // Czech month and day names
        const monthNames = [
            'Leden', 'Únor', 'Březen', 'Duben', 'Květen', 'Červen',
            'Červenec', 'Srpen', 'Září', 'Říjen', 'Listopad', 'Prosinec'
        ];

        const dayNames = ['Neděle', 'Pondělí', 'Úterý', 'Středa', 'Čtvrtek', 'Pátek', 'Sobota'];
        const dayNamesShort = ['Ne', 'Po', 'Út', 'St', 'Čt', 'Pá', 'So'];

        // Initialize calendar
        function init() {
            renderCalendar();
        }

        // Main render function
        function renderCalendar() {
            renderDesktopCalendar();
            updateMonthTitle();
        }

        // Update month title
        function updateMonthTitle() {
            const monthTitle = document.getElementById('monthTitle');
            monthTitle.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        }

        // Desktop calendar renderer
        function renderDesktopCalendar() {
            const grid = document.getElementById('calendarGrid');

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let html = '';

            // Determine start and end day
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);

            // Render each day in the month vertically
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                const isToday = date.getTime() === today.getTime();

                const dateStr = formatDate(date);
                const dayEvents = events[dateStr] || [];

                html += `<div class="day-card ${isToday ? 'today' : ''}">`;
                html += '<div class="day-card-header">';
                html += '<div class="day-card-info">';
                html += `<div class="day-card-number">${day}</div>`;
                html += `<div class="day-card-name">${dayNames[date.getDay()]}</div>`;
                html += '</div>';
                if (isToday) {
                    html += '<div class="day-card-badge">Dnes</div>';
                }
                html += '</div>';

                if (dayEvents.length > 0) {
                    html += '<div class="day-card-events">';
                    dayEvents.forEach(event => {
                        const displayName = event.subject ? `${event.subject} - ${event.name}` : event.name;
                        html += `<div class="event-item ${event.type}" onclick="showEventDetail('${event.id}')">${displayName}</div>`;
                    });
                    html += '</div>';
                } else {
                    html += '<div class="day-card-empty">Žádné události</div>';
                }

                html += '</div>';
            }

            // Add separator and next 7 days from next month
            const nextMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
            const nextMonthName = monthNames[nextMonth.getMonth()];

            html += `<div class="month-separator">`;
            html += `<div class="separator-line"></div>`;
            html += `<div class="separator-text">${nextMonthName}</div>`;
            html += `<div class="separator-line"></div>`;
            html += `</div>`;

            // Render first 7 days of next month
            for (let day = 1; day <= 7; day++) {
                const date = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), day);
                const isToday = date.getTime() === today.getTime();

                const dateStr = formatDate(date);
                const dayEvents = events[dateStr] || [];

                html += `<div class="day-card next-month ${isToday ? 'today' : ''}">`;
                html += '<div class="day-card-header">';
                html += '<div class="day-card-info">';
                html += `<div class="day-card-number">${day}</div>`;
                html += `<div class="day-card-name">${dayNames[date.getDay()]}</div>`;
                html += '</div>';
                if (isToday) {
                    html += '<div class="day-card-badge">Dnes</div>';
                }
                html += '</div>';

                if (dayEvents.length > 0) {
                    html += '<div class="day-card-events">';
                    dayEvents.forEach(event => {
                        const displayName = event.subject ? `${event.subject} - ${event.name}` : event.name;
                        html += `<div class="event-item ${event.type}" onclick="showEventDetail('${event.id}')">${displayName}</div>`;
                    });
                    html += '</div>';
                } else {
                    html += '<div class="day-card-empty">Žádné události</div>';
                }

                html += '</div>';
            }

            grid.innerHTML = html;

            // Scroll to today's card if in current month
            setTimeout(() => {
                const todayCard = document.querySelector('.day-card.today');
                if (todayCard) {
                    todayCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                // Setup today scroll button after initial scroll
                setupTodayScrollButton();
            }, 100);
        }

        // Today scroll button functions
        function scrollToToday() {
            const todayCard = document.querySelector('.day-card.today');
            if (todayCard) {
                todayCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function checkTodayButtonVisibility() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Only show button in current month
            const isCurrentMonth = currentDate.getMonth() === today.getMonth() &&
                                   currentDate.getFullYear() === today.getFullYear();

            const button = document.getElementById('todayScrollBtn');

            if (!isCurrentMonth) {
                button.classList.remove('show');
                return;
            }

            const todayCard = document.querySelector('.day-card.today');
            if (!todayCard) {
                button.classList.remove('show');
                return;
            }

            const rect = todayCard.getBoundingClientRect();
            const windowHeight = window.innerHeight;
            const windowCenter = windowHeight / 2;

            // Check if today card is roughly centered (within viewport center ±30%)
            const cardCenter = rect.top + (rect.height / 2);
            const isNearCenter = Math.abs(cardCenter - windowCenter) < (windowHeight * 0.3);

            if (isNearCenter) {
                button.classList.remove('show');
            } else {
                button.classList.add('show');

                // Update arrow direction based on position
                if (cardCenter > windowCenter) {
                    button.textContent = '↓';
                } else {
                    button.textContent = '↑';
                }
            }
        }

        let todayScrollButtonSetup = false;

        function setupTodayScrollButton() {
            if (todayScrollButtonSetup) {
                // Already set up, just check visibility
                checkTodayButtonVisibility();
                return;
            }

            // Check visibility on scroll and resize
            window.addEventListener('scroll', checkTodayButtonVisibility, { passive: true });
            window.addEventListener('resize', checkTodayButtonVisibility, { passive: true });

            todayScrollButtonSetup = true;

            // Initial check
            setTimeout(checkTodayButtonVisibility, 200);
        }

        // Event detail functions
        function showEventDetail(eventId) {
            const event = findEventById(eventId);
            if (!event) return;

            const modal = document.getElementById('eventDetailModal');
            const title = document.getElementById('eventDetailTitle');
            const content = document.getElementById('eventDetailContent');

            const typeNames = {
                'test': 'Test',
                'homework': 'Domácí úkol',
                'other': 'Jiné'
            };

            title.textContent = event.name;

            let html = `
                <div style="padding: 20px;">
                    <div style="margin-bottom: 16px;">
                        <strong>Typ:</strong> ${typeNames[event.type]}
                    </div>
                    ${event.subject ? `
                        <div style="margin-bottom: 16px;">
                            <strong>Předmět:</strong> ${event.subject}
                        </div>
                    ` : ''}
                    <div style="margin-bottom: 16px;">
                        <strong>Datum:</strong> ${event.date}
                    </div>
                    ${event.description ? `
                        <div style="margin-bottom: 16px;">
                            <strong>Popis:</strong><br>
                            <div style="margin-top: 8px; padding: 12px; background: var(--anthropic-warm-white); border-radius: var(--small-radius);">
                                ${event.description}
                            </div>
                        </div>
                    ` : ''}
                    ${event.files && event.files.length > 0 ? `
                        <div style="margin-bottom: 16px;">
                            <strong>Přílohy (${event.files.length}):</strong><br>
                            <div style="margin-top: 8px; display: flex; flex-direction: column; gap: 8px;">
                                ${event.files.map(file => `
                                    <a href="${file.downloadUrl || file.data}" download="${file.name}"
                                       target="_blank" rel="noopener noreferrer"
                                       style="display: inline-block; padding: 8px 12px; background: var(--anthropic-coral-light);
                                              color: var(--anthropic-coral); text-decoration: none; border-radius: var(--small-radius);
                                              font-weight: 500;">
                                        📎 ${file.name}
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    <div style="font-size: 12px; color: var(--anthropic-text-secondary); margin-top: 20px;">
                        Vytvořil: ${event.createdBy} • ${new Date(event.createdAt).toLocaleString('cs-CZ')}
                    </div>
                    ${(currentUser && currentUser.tier !== 'blocked') ? `
                        <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--anthropic-border-light); display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="openEditEvent('${event.id}')"
                                    style="padding: 8px 16px; background: rgba(255, 136, 0, 0.1); color: #ff8800;
                                           border: 1px solid rgba(255, 136, 0, 0.3); border-radius: var(--small-radius);
                                           cursor: pointer; font-weight: 500; transition: all 0.15s ease;"
                                    onmouseover="this.style.background='rgba(255, 136, 0, 0.2)'"
                                    onmouseout="this.style.background='rgba(255, 136, 0, 0.1)'">
                                ✏️ Upravit
                            </button>
                            <button onclick="deleteEvent('${event.id}')"
                                    style="padding: 8px 16px; background: rgba(220, 53, 69, 0.1); color: #dc3545;
                                           border: 1px solid rgba(220, 53, 69, 0.3); border-radius: var(--small-radius);
                                           cursor: pointer; font-weight: 500; transition: all 0.15s ease;"
                                    onmouseover="this.style.background='rgba(220, 53, 69, 0.2)'"
                                    onmouseout="this.style.background='rgba(220, 53, 69, 0.1)'">
                                Smazat
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;

            content.innerHTML = html;
            modal.classList.add('show');
            document.body.classList.add('modal-open');
        }

        function closeEventDetailModal() {
            closeModal('eventDetailModal');
        }

        async function deleteEvent(eventId) {
            if (!confirm('Opravdu chcete smazat tuto událost?')) {
                return;
            }

            // Find and remove the event
            for (const date in events) {
                const eventIndex = events[date].findIndex(e => e.id === eventId);
                if (eventIndex !== -1) {
                    events[date].splice(eventIndex, 1);
                    // Remove the date key if no events left for that day
                    if (events[date].length === 0) {
                        delete events[date];
                    }
                    break;
                }
            }

            await autoSave(); // Wait for save to complete
            renderCalendar(); // Re-render after save is done
            closeEventDetailModal();
        }

        function openEditEvent(eventId) {
            const event = findEventById(eventId);
            if (!event) return;

            closeEventDetailModal();

            // Set current event type and open modal
            currentEventType = event.type;
            isEditMode = true;
            editingEventId = eventId;

            const titles = {
                'test': 'Upravit test',
                'homework': 'Upravit domácí úkol',
                'other': 'Upravit jiné'
            };

            document.getElementById('eventModalTitle').textContent = titles[event.type];

            // Show/hide subject field based on event type
            const subjectGroup = document.getElementById('subjectGroup');
            const subjectField = document.getElementById('eventSubject');

            if (event.type === 'homework' || event.type === 'test') {
                subjectGroup.style.display = 'block';
                subjectField.required = true;
            } else {
                subjectGroup.style.display = 'none';
                subjectField.required = false;
            }

            // Pre-fill form with event data
            document.getElementById('eventName').value = event.name;
            document.getElementById('eventDate').value = event.date;
            document.getElementById('eventDescription').value = event.description || '';
            document.getElementById('eventSubject').value = event.subject || '';

            // Show existing files if present
            if (event.files && event.files.length > 0) {
                existingFiles = event.files.map(f => ({...f, id: f.id || (f.name + '_' + Date.now())}));
                renderFilesList();
            }

            // Set date constraints
            const today = new Date();
            const todayStr = formatDate(today);
            const maxDate = new Date(today.getFullYear() + 5, today.getMonth(), today.getDate());
            const maxDateStr = formatDate(maxDate);

            const dateInput = document.getElementById('eventDate');
            dateInput.min = todayStr;
            dateInput.max = maxDateStr;

            document.getElementById('eventModal').classList.add('show');
            document.body.classList.add('modal-open');
        }

        function findEventById(eventId) {
            for (const date in events) {
                const event = events[date].find(e => e.id === eventId);
                if (event) return event;
            }
            return null;
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Navigation functions
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
            setTimeout(checkTodayButtonVisibility, 200);
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
            setTimeout(checkTodayButtonVisibility, 200);
        }


        // Dropdown menu functions
        function openMenu() {
            document.getElementById('dropdownMenu').classList.add('show');
            document.getElementById('hamburgerBtn').classList.add('active');
        }

        function closeMenu() {
            document.getElementById('dropdownMenu').classList.remove('show');
            document.getElementById('hamburgerBtn').classList.remove('active');
        }

        function toggleMenu() {
            const menu = document.getElementById('dropdownMenu');
            if (menu.classList.contains('show')) {
                closeMenu();
            } else {
                openMenu();
            }
        }

        function openLogin() {
            closeMenu();
            document.getElementById('loginModal').classList.add('show');
            document.body.classList.add('modal-open');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('hiding');
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');

            setTimeout(() => {
                modal.classList.remove('hiding');
            }, 300);
        }

        function closeLoginModal() {
            closeModal('loginModal');
        }

        function closeModalOverlay(event, modalId = 'loginModal') {
            if (event.target === event.currentTarget) {
                closeModal(modalId);
            }
        }

        // Add User Modal Functions
        function openAddUserModal() {
            closeMenu();
            document.getElementById('addUserModal').classList.add('show');
            document.body.classList.add('modal-open');
        }

        function closeAddUserModal() {
            closeModal('addUserModal');
        }

        async function handleAddUser(event) {
            event.preventDefault();

            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;

            if (users[username]) {
                alert('Uživatel s tímto jménem již existuje');
                return;
            }

            users[username] = {
                password: password,
                name: username.charAt(0).toUpperCase() + username.slice(1),
                tier: 'basic'
            };

            await autoSave(); // Wait for save to complete
            renderUserList(); // Refresh user list to show new user
            closeAddUserModal();

            // Clear form
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';

            alert(`Uživatel ${username} byl úspěšně přidán`);
        }

        // Event modal functions
        function openEventModal(type) {
            closeMenu();
            currentEventType = type;

            const titles = {
                'test': 'Přidat test',
                'homework': 'Přidat domácí úkol',
                'other': 'Přidat jiné'
            };

            document.getElementById('eventModalTitle').textContent = titles[type];

            // Show/hide subject field based on event type
            const subjectGroup = document.getElementById('subjectGroup');
            const subjectField = document.getElementById('eventSubject');

            if (type === 'homework' || type === 'test') {
                subjectGroup.style.display = 'block';
                subjectField.required = true;
            } else {
                subjectGroup.style.display = 'none';
                subjectField.required = false;
                subjectField.value = '';
            }

            document.getElementById('eventModal').classList.add('show');
            document.body.classList.add('modal-open');

            // Set date constraints and default value (use local timezone)
            const today = new Date();
            const todayStr = formatDate(today); // Use local timezone formatting
            const maxDate = new Date(today.getFullYear() + 5, today.getMonth(), today.getDate());
            const maxDateStr = formatDate(maxDate); // Use local timezone formatting

            const dateInput = document.getElementById('eventDate');
            dateInput.min = todayStr;
            dateInput.max = maxDateStr;
            dateInput.value = todayStr;
        }

        function closeEventModal() {
            closeModal('eventModal');
            clearEventForm();
        }

        function clearEventForm() {
            document.getElementById('eventName').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventSubject').value = '';
            document.getElementById('eventFile').value = '';
            selectedFiles = [];
            existingFiles = [];
            isEditMode = false;
            editingEventId = null;
            renderFilesList();
        }

        async function handleAddEvent(event) {
            event.preventDefault();

            const name = document.getElementById('eventName').value;
            const date = document.getElementById('eventDate').value;
            const description = document.getElementById('eventDescription').value;
            const subject = document.getElementById('eventSubject').value;

            if (isEditMode) {
                // Edit existing event
                await handleEditEvent(name, date, description, subject);
                await autoSave();
                renderCalendar();
                closeEventModal();
            } else {
                // Create new event
                const eventId = Date.now().toString();
                const filesToUpload = [...selectedFiles]; // Copy array before clearing

                // Create event without files first (for instant save)
                const newEvent = {
                    id: eventId,
                    name: name,
                    type: currentEventType,
                    date: date,
                    description: description,
                    subject: subject || null,
                    files: [], // Start with empty files
                    createdBy: currentUser.username,
                    createdAt: new Date().toISOString()
                };

                if (!events[date]) {
                    events[date] = [];
                }

                events[date].push(newEvent);

                // Save event immediately
                await autoSave();
                renderCalendar();
                closeEventModal();

                // Upload files in background if any
                if (filesToUpload.length > 0) {
                    console.log(`📎 Starting background upload of ${filesToUpload.length} file(s)...`);

                    // Upload files in background (this happens after modal is closed)
                    const uploadedFiles = await uploadFilesInBackground(filesToUpload, eventId);

                    // Update event with uploaded files
                    if (uploadedFiles.length > 0) {
                        const eventToUpdate = events[date].find(e => e.id === eventId);
                        if (eventToUpdate) {
                            eventToUpdate.files = uploadedFiles;
                            await autoSave(); // Save again with files
                            renderCalendar(); // Re-render to show files
                            console.log(`✅ Event updated with ${uploadedFiles.length} file(s)`);
                        }
                    }
                }
            }

            return false;
        }

        async function handleEditEvent(name, date, description, subject) {
            // Find the event
            let eventToEdit = null;
            let oldDate = null;

            for (const d in events) {
                const event = events[d].find(e => e.id === editingEventId);
                if (event) {
                    eventToEdit = event;
                    oldDate = d;
                    break;
                }
            }

            if (!eventToEdit) return;

            // Combine existing files (not removed) with newly selected files
            let allFiles = [...existingFiles];

            // Upload new files if selected (in parallel for speed)
            if (selectedFiles.length > 0) {
                console.log(`📎 Uploading ${selectedFiles.length} new attachment(s) in parallel...`);

                // Upload all files at once in parallel
                const uploadPromises = selectedFiles.map(file => saveFileToGitHub(file, editingEventId));
                const uploadResults = await Promise.all(uploadPromises);

                // Check if all uploads succeeded
                for (let i = 0; i < uploadResults.length; i++) {
                    const uploaded = uploadResults[i];
                    if (uploaded) {
                        allFiles.push(uploaded);
                        console.log('✅ New attachment uploaded:', uploaded.name);
                    } else {
                        console.log('⚠️ Attachment upload failed:', selectedFiles[i].name);
                        alert(`Nahrání souboru "${selectedFiles[i].name}" selhalo. Zkus to prosím znovu.`);
                        return;
                    }
                }
            }

            // Update event data
            eventToEdit.name = name;
            eventToEdit.date = date;
            eventToEdit.description = description;
            eventToEdit.subject = subject || null;
            eventToEdit.files = allFiles;

            // If date changed, move event to new date
            if (oldDate !== date) {
                // Remove from old date
                const oldIndex = events[oldDate].findIndex(e => e.id === editingEventId);
                if (oldIndex !== -1) {
                    events[oldDate].splice(oldIndex, 1);
                    if (events[oldDate].length === 0) {
                        delete events[oldDate];
                    }
                }

                // Add to new date
                if (!events[date]) {
                    events[date] = [];
                }
                events[date].push(eventToEdit);
            }
        }

        // Toast notification functions
        function showUploadToast(message) {
            const toast = document.getElementById('uploadToast');
            const text = document.getElementById('uploadToastText');
            text.textContent = message;
            toast.classList.add('show');
        }

        function hideUploadToast() {
            const toast = document.getElementById('uploadToast');
            toast.classList.remove('show');
        }

        // Background file upload function
        async function uploadFilesInBackground(files, eventId) {
            if (files.length === 0) return [];

            showUploadToast(`Nahrávám ${files.length} soubor(ů) na pozadí...`);

            try {
                // Upload all files in parallel
                const uploadPromises = files.map(file => saveFileToGitHub(file, eventId));
                const uploadResults = await Promise.all(uploadPromises);

                // Filter out failed uploads
                const successfulUploads = uploadResults.filter(result => result !== null);

                if (successfulUploads.length === files.length) {
                    showUploadToast('✅ Všechny soubory nahrány!');
                    setTimeout(hideUploadToast, 3000);
                } else if (successfulUploads.length > 0) {
                    showUploadToast(`⚠️ Nahráno ${successfulUploads.length}/${files.length} souborů`);
                    setTimeout(hideUploadToast, 5000);
                } else {
                    showUploadToast('❌ Nahrávání selhalo');
                    setTimeout(hideUploadToast, 5000);
                }

                return successfulUploads;
            } catch (error) {
                console.error('Background upload failed:', error);
                showUploadToast('❌ Nahrávání selhalo');
                setTimeout(hideUploadToast, 5000);
                return [];
            }
        }

        // File handling functions
        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        selectedFiles.push({
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: e.target.result,
                            id: Date.now() + '_' + i // Unique ID for removal
                        });
                        renderFilesList();
                    };
                    reader.readAsDataURL(file);
                }
            }
            // Reset input so same file can be added again
            event.target.value = '';
        }

        function removeFile(fileId, isExisting) {
            if (isExisting) {
                existingFiles = existingFiles.filter(f => f.id !== fileId);
            } else {
                selectedFiles = selectedFiles.filter(f => f.id !== fileId);
            }
            renderFilesList();
        }

        function renderFilesList() {
            const filesList = document.getElementById('filesList');
            let html = '';

            // Show existing files (when editing)
            existingFiles.forEach(file => {
                html += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px;
                                background: var(--anthropic-warm-white); border-radius: var(--small-radius); margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0;">
                            <span style="font-size: 16px;">📎</span>
                            <span style="font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.name}</span>
                            <span style="font-size: 11px; color: var(--anthropic-text-secondary);">(existující)</span>
                        </div>
                        <button type="button" onclick="removeFile('${file.id}', true)"
                                style="padding: 4px 8px; background: rgba(220, 53, 69, 0.1); color: #dc3545;
                                       border: 1px solid rgba(220, 53, 69, 0.3); border-radius: 4px;
                                       cursor: pointer; font-size: 12px; flex-shrink: 0;">
                            Odebrat
                        </button>
                    </div>
                `;
            });

            // Show newly selected files
            selectedFiles.forEach(file => {
                const sizeKB = (file.size / 1024).toFixed(1);
                html += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px;
                                background: var(--anthropic-coral-light); border-radius: var(--small-radius); margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0;">
                            <span style="font-size: 16px;">📎</span>
                            <span style="font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.name}</span>
                            <span style="font-size: 11px; color: var(--anthropic-text-secondary);">(${sizeKB} KB)</span>
                        </div>
                        <button type="button" onclick="removeFile('${file.id}', false)"
                                style="padding: 4px 8px; background: rgba(220, 53, 69, 0.1); color: #dc3545;
                                       border: 1px solid rgba(220, 53, 69, 0.3); border-radius: 4px;
                                       cursor: pointer; font-size: 12px; flex-shrink: 0;">
                            Odebrat
                        </button>
                    </div>
                `;
            });

            filesList.innerHTML = html;
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const fileInput = document.getElementById('eventFile');
                fileInput.files = files;
                handleFileSelect({ target: { files: files } });
            }
        }

        // Manage Users Modal Functions
        function openManageUsersModal() {
            closeMenu();
            renderUserList();
            document.getElementById('manageUsersModal').classList.add('show');
            document.body.classList.add('modal-open');
        }

        function closeManageUsersModal() {
            closeModal('manageUsersModal');
        }

        function renderUserList() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';

            Object.keys(users).forEach(username => {
                const user = users[username];
                const userItem = document.createElement('div');
                userItem.className = 'user-item';

                userItem.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">${user.name}</div>
                        <span class="user-tier ${user.tier}">${user.tier}</span>
                    </div>
                    <div class="user-actions">
                        ${username !== 'admin' ? `
                            ${user.tier === 'basic' ?
                                `<button class="btn-small" onclick="changeUserTier('${username}', 'admin')">Povýšit na Admin</button>` :
                                user.tier === 'admin' ?
                                    `<button class="btn-small" onclick="changeUserTier('${username}', 'basic')">Degradovat na Basic</button>` : ''
                            }
                            ${user.tier !== 'blocked' ?
                                `<button class="btn-small" onclick="changeUserTier('${username}', 'blocked')" style="background: rgba(220, 53, 69, 0.1); color: #dc3545;">Zablokovat</button>` :
                                `<button class="btn-small" onclick="changeUserTier('${username}', 'basic')" style="background: var(--anthropic-coral-light); color: var(--anthropic-coral);">Odblokovat</button>`
                            }
                        ` : ''}
                    </div>
                `;

                userList.appendChild(userItem);
            });
        }

        async function changeUserTier(username, newTier) {
            if (username === 'admin' && newTier === 'basic') {
                alert('Hlavního admina nelze degradovat');
                return;
            }

            users[username].tier = newTier;
            await autoSave(); // Wait for save to complete
            renderUserList(); // Re-render after save is done

            // If the current user's tier was changed, update their menu
            if (currentUser && currentUser.username === username) {
                currentUser.tier = newTier;
                if (newTier === 'basic') {
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
                updateMenuForLoggedUser();
            }
        }

        function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const stayLoggedIn = document.getElementById('stayLoggedIn').checked;

            // Debug info for mobile
            console.log('Login attempt:', { username, password, availableUsers: Object.keys(users) });

            // Find user by case-insensitive username
            const userKey = Object.keys(users).find(key => key.toLowerCase() === username.toLowerCase());

            console.log('Found user key:', userKey);

            if (userKey) {
                const storedPassword = users[userKey].password;
                console.log('Password comparison:', {
                    entered: password,
                    enteredLower: password.toLowerCase(),
                    stored: storedPassword,
                    storedLower: storedPassword.toLowerCase(),
                    match: storedPassword.toLowerCase() === password.toLowerCase()
                });
            }

            if (userKey && users[userKey].password.toLowerCase() === password.toLowerCase()) {
                currentUser = {
                    username: userKey,
                    name: users[userKey].name,
                    tier: users[userKey].tier
                };

                if (stayLoggedIn) {
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }

                updateMenuForLoggedUser();
                closeLoginModal();

                // Clear form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('stayLoggedIn').checked = false;

                console.log('Login successful:', currentUser);
            } else {
                console.log('Login failed - user or password incorrect');
                alert('Nesprávné jméno nebo heslo');
            }
        }

        function updateMenuForLoggedUser() {
            const dropdownMenu = document.getElementById('dropdownMenu');

            if (currentUser.tier === 'blocked') {
                dropdownMenu.innerHTML = `
                    <button class="menu-item blocked" onclick="return false;">Přidat test</button>
                    <button class="menu-item blocked" onclick="return false;">Přidat domácí úkol</button>
                    <button class="menu-item blocked" onclick="return false;">Přidat jiné</button>
                    <div class="menu-separator"></div>
                    <button class="menu-item logout" onclick="logout()">Odhlásit se</button>
                `;
            } else if (currentUser.tier === 'admin') {
                dropdownMenu.innerHTML = `
                    <button class="menu-item" onclick="openEventModal('test')">Přidat test</button>
                    <button class="menu-item" onclick="openEventModal('homework')">Přidat domácí úkol</button>
                    <button class="menu-item" onclick="openEventModal('other')">Přidat jiné</button>
                    <div class="menu-separator"></div>
                    <button class="menu-item" onclick="openAddUserModal()">Přidat uživatele</button>
                    <button class="menu-item" onclick="openManageUsersModal()">Správa uživatelů</button>
                    <div class="menu-separator"></div>
                    <button class="menu-item logout" onclick="logout()">Odhlásit se</button>
                `;
            } else { // basic
                dropdownMenu.innerHTML = `
                    <button class="menu-item" onclick="openEventModal('test')">Přidat test</button>
                    <button class="menu-item" onclick="openEventModal('homework')">Přidat domácí úkol</button>
                    <button class="menu-item" onclick="openEventModal('other')">Přidat jiné</button>
                    <div class="menu-separator"></div>
                    <button class="menu-item logout" onclick="logout()">Odhlásit se</button>
                `;
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');

            const dropdownMenu = document.getElementById('dropdownMenu');
            dropdownMenu.innerHTML = '<button class="menu-item" onclick="openLogin()">Přihlásit se</button>';

            closeMenu();
        }

        async function manualRefresh() {
            closeMenu();
            console.log('🔄 Manual refresh triggered');
            await loadDataFromDatabase();
            renderCalendar();
            alert('Data aktualizována!');
        }

        function checkStoredLogin() {
            const stored = localStorage.getItem('currentUser');
            if (stored) {
                currentUser = JSON.parse(stored);
                updateMenuForLoggedUser();
            }
        }


        // Close menu with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeMenu();
                closeLoginModal();
                closeAddUserModal();
                closeManageUsersModal();
                closeEventModal();
                closeEventDetailModal();
            }
        });

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const hamburgerWrapper = document.querySelector('.hamburger-wrapper');
            if (!hamburgerWrapper.contains(event.target)) {
                closeMenu();
            }
        });

        // Initialize when page loads
        window.onload = async function() {
            console.log('=== INITIALIZING CALENDAR ===');
            console.log('Screen width:', window.innerWidth);

            // Load data from database first
            await loadDataFromDatabase();

            console.log('=== DEBUG INFO ===');
            console.log('Users data:', users);
            console.log('Events data:', events);
            console.log('Data loaded:', isDataLoaded);
            console.log('==============================');

            init();
            checkStoredLogin();
        };
    </script>

    <!-- Toast notification for background uploads -->
    <div id="uploadToast" class="upload-toast">
        <div class="upload-toast-content">
            <div class="upload-toast-spinner"></div>
            <div class="upload-toast-text" id="uploadToastText">Nahrávám soubory...</div>
        </div>
    </div>
</body>
</html>