<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalendář Úkolů</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Anthropic.com professional beige palette */
            --anthropic-coral: #d97757;
            --anthropic-coral-light: rgba(217, 119, 87, 0.08);
            --anthropic-coral-selection: rgba(204, 120, 92, 0.3);
            --anthropic-bg: #f8f6f0;
            --anthropic-card-bg: #ffffff;
            --anthropic-warm-white: #fefdfb;
            --anthropic-text: #2c2a26;
            --anthropic-text-secondary: #8b8680;
            --anthropic-text-muted: #b5b1a8;
            --anthropic-border: #e8e5de;
            --anthropic-border-light: #f0edea;
            --anthropic-shadow: rgba(44, 42, 38, 0.06);
            --anthropic-shadow-strong: rgba(44, 42, 38, 0.12);
            --border-radius: 12px;
            --small-radius: 6px;

            /* Event colors */
            --homework-color: #22c55e;
            --homework-light: rgba(34, 197, 94, 0.1);
            --test-color: #eab308;
            --test-light: rgba(234, 179, 8, 0.1);
            --other-color: #3b82f6;
            --other-light: rgba(59, 130, 246, 0.1);
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: var(--anthropic-bg);
            color: var(--anthropic-text);
            line-height: 1.5;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            letter-spacing: -0.01em;
        }

        /* Container */
        .calendar-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* Header */
        .calendar-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
            padding: 0 8px;
            position: relative;
            gap: 32px;
        }

        /* Mobile sticky header with smart behavior */
        @media (max-width: 768px) {
            .calendar-header {
                position: sticky;
                top: 0;
                z-index: 100;
                background: var(--anthropic-bg);
                margin-bottom: 0;
                padding: 16px 8px;
                border-bottom: 1px solid var(--anthropic-border-light);
                box-shadow: 0 2px 8px var(--anthropic-shadow);
                transition: transform 0.3s ease;
            }


            .calendar-mobile {
                padding-top: 20px;
            }
        }


        .hamburger-container {
            position: absolute;
            top: 8px;
            right: 0;
        }

        .hamburger-wrapper {
            position: relative;
            display: inline-block;
        }

        .month-title {
            font-family: 'Poppins', 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            font-size: 2.2rem;
            font-weight: 500;
            color: var(--anthropic-text);
            letter-spacing: -0.02em;
            min-width: 200px;
            text-align: center;
            text-transform: uppercase;
            font-variant: small-caps;
        }

        .nav-btn {
            background: var(--anthropic-warm-white);
            border: 1px solid var(--anthropic-border);
            border-radius: var(--small-radius);
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 500;
            color: var(--anthropic-text-secondary);
            transition: all 0.15s ease;
            box-shadow: 0 1px 3px var(--anthropic-shadow);
        }

        .nav-btn:hover {
            background: var(--anthropic-coral-light);
            border-color: var(--anthropic-coral);
            color: var(--anthropic-coral);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px var(--anthropic-shadow-strong);
        }

        /* Hamburger Menu */
        .hamburger-btn {
            background: var(--anthropic-warm-white);
            border: 1px solid var(--anthropic-border);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px var(--anthropic-shadow);
            position: relative;
            overflow: hidden;
        }

        .hamburger-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--anthropic-coral-light);
            border-radius: 50%;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translate(-50%, -50%);
            z-index: 0;
        }

        .hamburger-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px var(--anthropic-shadow-strong);
            border-color: var(--anthropic-coral);
        }

        .hamburger-btn:hover::before {
            width: 100%;
            height: 100%;
        }

        .hamburger-btn:active {
            transform: translateY(0) scale(0.95);
        }

        .hamburger-line {
            width: 20px;
            height: 2px;
            background: var(--anthropic-text-secondary);
            border-radius: 2px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
        }

        .hamburger-btn:hover .hamburger-line {
            background: var(--anthropic-coral);
            transform: scale(1.1);
        }

        .hamburger-btn.active .hamburger-line:nth-child(1) {
            transform: translateY(5px) rotate(45deg);
        }

        .hamburger-btn.active .hamburger-line:nth-child(2) {
            opacity: 0;
            transform: scale(0);
        }

        .hamburger-btn.active .hamburger-line:nth-child(3) {
            transform: translateY(-5px) rotate(-45deg);
        }

        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--anthropic-card-bg);
            border: 1px solid var(--anthropic-border);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px var(--anthropic-shadow-strong);
            transform-origin: top right;
            transform: scale(0);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            min-width: 220px;
            margin-top: 8px;
            padding: 12px;
        }

        .dropdown-menu.show {
            transform: scale(1);
            opacity: 1;
            visibility: visible;
        }

        .dropdown-menu::before {
            content: '';
            position: absolute;
            top: -6px;
            right: 12px;
            width: 12px;
            height: 12px;
            background: var(--anthropic-card-bg);
            border: 1px solid var(--anthropic-border);
            border-bottom: none;
            border-right: none;
            transform: rotate(45deg);
        }

        .menu-item {
            display: block;
            width: 100%;
            padding: 14px 16px;
            background: var(--anthropic-warm-white);
            border: 1px solid var(--anthropic-border-light);
            border-radius: var(--small-radius);
            color: var(--anthropic-text);
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
            margin-bottom: 8px;
        }

        .menu-item:last-child {
            margin-bottom: 0;
        }

        .menu-item:hover {
            background: var(--anthropic-coral-light);
            border-color: var(--anthropic-coral);
            color: var(--anthropic-coral);
            transform: translateY(-1px);
        }

        .menu-item.logout {
            color: #dc3545;
            border-color: rgba(220, 53, 69, 0.2);
            background: rgba(220, 53, 69, 0.05);
        }

        .menu-item.logout:hover {
            background: rgba(220, 53, 69, 0.1);
            border-color: #dc3545;
            color: #dc3545;
        }

        .menu-separator {
            height: 1px;
            background: var(--anthropic-border-light);
            margin: 8px 0;
        }

        .menu-item.blocked {
            background: var(--anthropic-border-light);
            color: var(--anthropic-text-muted);
            border-color: var(--anthropic-border-light);
            cursor: not-allowed;
            position: relative;
            overflow: hidden;
        }

        .menu-item.blocked:hover {
            background: var(--anthropic-border-light);
            color: var(--anthropic-text-muted);
            border-color: var(--anthropic-border-light);
            transform: none;
        }

        .menu-item.blocked::after {
            content: "TENTO ÚČET JE ZABLOKOVÁN";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        /* Login Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(44, 42, 38, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 2000;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-overlay.hiding {
            opacity: 0;
            visibility: visible;
        }

        .modal {
            background: var(--anthropic-card-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 16px 64px var(--anthropic-shadow-strong);
            padding: 32px;
            width: 90%;
            max-width: 400px;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-overlay.show .modal {
            transform: scale(1) translateY(0);
        }

        .modal-overlay.hiding .modal {
            transform: scale(0.9) translateY(20px);
        }

        .modal-header {
            margin-bottom: 24px;
            text-align: center;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 32px;
            height: 32px;
            background: var(--anthropic-warm-white);
            border: 1px solid var(--anthropic-border);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 500;
            color: var(--anthropic-text-secondary);
            transition: all 0.15s ease;
            box-shadow: 0 2px 8px var(--anthropic-shadow);
        }

        .modal-close:hover {
            background: rgba(220, 53, 69, 0.1);
            border-color: #dc3545;
            color: #dc3545;
            transform: scale(1.1);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--anthropic-text);
            margin-bottom: 8px;
        }

        .modal-subtitle {
            color: var(--anthropic-text-secondary);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--anthropic-text);
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--anthropic-border);
            border-radius: var(--small-radius);
            font-size: 14px;
            font-family: inherit;
            background: var(--anthropic-warm-white);
            color: var(--anthropic-text);
            transition: all 0.15s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--anthropic-coral);
            box-shadow: 0 0 0 3px var(--anthropic-coral-light);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--anthropic-coral);
        }

        .checkbox-group label {
            font-size: 14px;
            color: var(--anthropic-text-secondary);
            cursor: pointer;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 24px;
            border-radius: var(--small-radius);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
            font-family: inherit;
        }

        .btn-secondary {
            background: var(--anthropic-warm-white);
            color: var(--anthropic-text-secondary);
            border: 1px solid var(--anthropic-border);
        }

        .btn-secondary:hover {
            background: var(--anthropic-border-light);
            color: var(--anthropic-text);
        }

        .btn-primary {
            background: var(--anthropic-coral);
            color: white;
            border: 1px solid var(--anthropic-coral);
        }

        .btn-primary:hover {
            background: #c15946;
            transform: translateY(-1px);
        }

        /* User Management Styles */
        .user-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--anthropic-warm-white);
            border: 1px solid var(--anthropic-border-light);
            border-radius: var(--small-radius);
            margin-bottom: 8px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-name {
            font-weight: 600;
            color: var(--anthropic-text);
        }

        .user-tier {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .user-tier.admin {
            background: var(--anthropic-coral-light);
            color: var(--anthropic-coral);
        }

        .user-tier.basic {
            background: var(--anthropic-border-light);
            color: var(--anthropic-text-secondary);
        }

        .user-tier.blocked {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: var(--small-radius);
            border: 1px solid var(--anthropic-border);
            background: var(--anthropic-warm-white);
            color: var(--anthropic-text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-small:hover {
            background: var(--anthropic-coral-light);
            border-color: var(--anthropic-coral);
            color: var(--anthropic-coral);
        }

        /* File Upload Styles */
        .file-upload-area {
            border: 2px dashed var(--anthropic-border);
            border-radius: var(--small-radius);
            padding: 20px;
            text-align: center;
            background: var(--anthropic-warm-white);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .file-upload-area:hover {
            border-color: var(--anthropic-coral);
            background: var(--anthropic-coral-light);
        }

        .file-upload-area.dragover {
            border-color: var(--anthropic-coral);
            background: var(--anthropic-coral-light);
        }

        .file-upload-text {
            color: var(--anthropic-text-secondary);
            font-size: 14px;
        }

        .file-selected {
            margin-top: 8px;
            padding: 8px 12px;
            background: var(--anthropic-coral-light);
            border-radius: var(--small-radius);
            color: var(--anthropic-coral);
            font-size: 13px;
            font-weight: 500;
        }

        /* Desktop Calendar (Full Month Grid) */
        .calendar-desktop {
            background: var(--anthropic-card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--anthropic-border-light);
            box-shadow: 0 2px 12px var(--anthropic-shadow);
            overflow: hidden;
            display: block;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .day-header {
            background: var(--anthropic-warm-white);
            padding: 18px 12px;
            text-align: center;
            font-weight: 500;
            font-size: 13px;
            color: var(--anthropic-text-muted);
            border-bottom: 1px solid var(--anthropic-border-light);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .calendar-day {
            min-height: 130px;
            border-right: 1px solid var(--anthropic-border-light);
            border-bottom: 1px solid var(--anthropic-border-light);
            padding: 14px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            flex-direction: column;
            position: relative;
            background: var(--anthropic-card-bg);
        }

        .calendar-day:hover {
            background: var(--anthropic-coral-light);
        }

        .calendar-day.other-month {
            background: var(--anthropic-warm-white);
            color: var(--anthropic-text-muted);
            opacity: 0.6;
        }

        .calendar-day.today {
            background: var(--anthropic-coral-light);
            border: 1px solid var(--anthropic-coral);
            position: relative;
        }

        .calendar-day.today::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid var(--anthropic-coral);
            border-radius: 0;
            pointer-events: none;
        }

        .day-number {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 10px;
            color: var(--anthropic-text);
        }

        .calendar-day.today .day-number {
            color: var(--anthropic-coral);
            font-weight: 700;
        }

        .day-events {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .event-item {
            padding: 4px 8px;
            border-radius: var(--small-radius);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid;
            background: var(--anthropic-warm-white);
            color: var(--anthropic-text);
            line-height: 1.2;
        }

        .event-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px var(--anthropic-shadow);
        }

        .event-item.homework {
            border-color: var(--homework-color);
            background: var(--homework-light);
        }

        .event-item.test {
            border-color: var(--test-color);
            background: var(--test-light);
        }

        .event-item.other {
            border-color: var(--other-color);
            background: var(--other-light);
        }

        /* Mobile Calendar (Scrollable Daily Cards) */
        .calendar-mobile {
            display: none;
        }

        .daily-cards-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 0 2px;
        }

        .daily-card {
            background: var(--anthropic-card-bg);
            border-radius: 16px;
            box-shadow: 0 2px 12px var(--anthropic-shadow);
            padding: 20px;
            transition: all 0.2s ease;
            border: 1px solid var(--anthropic-border-light);
            position: relative;
            overflow: hidden;
        }

        .daily-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px var(--anthropic-shadow-strong);
        }


        .daily-card.today {
            background: linear-gradient(135deg, var(--anthropic-coral-light), var(--anthropic-card-bg));
            border-color: var(--anthropic-coral);
            box-shadow: 0 4px 24px var(--anthropic-coral-selection);
        }

        .daily-card.today::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--anthropic-coral), #c15946);
        }

        .daily-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--anthropic-border-light);
        }

        .daily-card.today .daily-card-header {
            border-bottom-color: rgba(217, 119, 87, 0.2);
        }

        .daily-card-date-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .daily-card-date {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--anthropic-text);
            line-height: 1;
        }

        .daily-card.today .daily-card-date {
            color: var(--anthropic-coral);
            font-weight: 800;
        }

        .daily-card-day {
            font-size: 13px;
            color: var(--anthropic-text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .daily-card.today .daily-card-day {
            color: var(--anthropic-coral);
            font-weight: 600;
        }

        .daily-card-badge {
            background: var(--anthropic-border-light);
            color: var(--anthropic-text-muted);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .daily-card.today .daily-card-badge {
            background: var(--anthropic-coral);
            color: white;
        }

        .daily-card-events {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .daily-card-empty {
            text-align: center;
            color: var(--anthropic-text-muted);
            font-style: italic;
            padding: 24px;
            font-size: 14px;
            background: var(--anthropic-border-light);
            border-radius: 8px;
            margin-top: 8px;
        }

        .daily-card.today .daily-card-empty {
            background: rgba(217, 119, 87, 0.1);
            color: var(--anthropic-coral);
            font-style: normal;
            font-weight: 500;
        }

        /* Month separator */
        .month-separator {
            display: flex;
            align-items: center;
            margin: 24px 0;
            gap: 16px;
        }

        .separator-line {
            flex: 1;
            height: 1px;
            background: var(--anthropic-border);
        }

        .separator-text {
            color: var(--anthropic-text-secondary);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 8px;
        }

        /* Smart Today Button */
        .today-button {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 56px;
            height: 56px;
            background: var(--anthropic-coral);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 6px 24px var(--anthropic-shadow-strong);
            transition: all 0.3s ease;
            opacity: 0;
            visibility: hidden;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .today-button.show {
            opacity: 1;
            visibility: visible;
        }

        .today-button:hover {
            background: #c15946;
            transform: translateY(-3px);
            box-shadow: 0 8px 32px var(--anthropic-shadow-strong);
        }

        .today-button.direction-up::before {
            content: '↑';
        }

        .today-button.direction-down::before {
            content: '↓';
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .calendar-day {
                min-height: 110px;
                padding: 12px;
            }

            .month-title {
                font-size: 2.1rem;
                min-width: 180px;
            }

            .calendar-header {
                gap: 24px;
            }
        }

        @media (max-width: 900px) {
            .calendar-day {
                min-height: 100px;
                padding: 10px;
            }

            .day-number {
                font-size: 15px;
            }

            .month-title {
                font-size: 1.9rem;
                min-width: 160px;
            }

            .calendar-header {
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .calendar-desktop {
                display: none;
            }

            .calendar-mobile {
                display: block;
            }

            .calendar-container {
                padding: 12px;
            }

            .calendar-header {
                margin-bottom: 20px;
                gap: 16px;
            }

            .month-title {
                font-size: 1.8rem;
                min-width: 120px;
            }

            .nav-btn {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }

            .hamburger-btn {
                width: 40px;
                height: 40px;
            }

            .hamburger-container {
                top: 4px;
            }

            .dropdown-menu {
                min-width: 200px;
                margin-top: 6px;
            }

            /* Mobile-specific event styling */
            .calendar-mobile .event-item {
                padding: 8px 12px;
                font-size: 13px;
                border-radius: 8px;
                font-weight: 500;
                line-height: 1.3;
                border: 1px solid;
                transition: all 0.2s ease;
            }

            .calendar-mobile .event-item:hover {
                transform: translateY(-1px);
                box-shadow: 0 3px 12px var(--anthropic-shadow);
            }

            .today-button {
                bottom: 24px;
                right: 24px;
                width: 48px;
                height: 48px;
                font-size: 18px;
            }

            /* Mobile form improvements */
            .modal {
                padding: 24px;
                width: 95%;
                max-width: 350px;
            }

            .form-input {
                padding: 14px 16px;
                font-size: 16px; /* Prevents zoom on iOS */
                border-radius: 8px;
            }

            .btn {
                padding: 14px 24px;
                font-size: 16px;
                border-radius: 8px;
                min-height: 48px; /* Better touch target */
            }

            .modal-close {
                width: 36px;
                height: 36px;
                font-size: 18px;
                top: -6px;
                right: -6px;
            }

            .checkbox-group {
                margin-bottom: 20px;
            }

            .checkbox-group input[type="checkbox"] {
                width: 20px;
                height: 20px;
            }
        }

        @media (max-width: 480px) {
            .calendar-container {
                padding: 8px;
            }

            .month-title {
                font-size: 1.6rem;
                min-width: 100px;
            }

            .calendar-header {
                gap: 12px;
                margin-bottom: 16px;
            }

            .nav-btn {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }

            .hamburger-btn {
                width: 36px;
                height: 36px;
            }


            .daily-cards-container {
                gap: 12px;
            }

            .daily-card {
                padding: 16px;
                border-radius: 12px;
            }

            .daily-card-date {
                font-size: 1.6rem;
            }

            .daily-card-day {
                font-size: 12px;
            }

            .daily-card-badge {
                padding: 3px 6px;
                font-size: 10px;
            }

            .daily-card-header {
                margin-bottom: 12px;
                padding-bottom: 10px;
            }

            .calendar-mobile .event-item {
                padding: 6px 10px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="calendar-container">
        <!-- Header -->
        <div class="calendar-header">
            <button class="nav-btn" onclick="previousMonth()">‹</button>
            <h1 class="month-title" id="monthTitle">Září 2025</h1>
            <button class="nav-btn" onclick="nextMonth()">›</button>
            <div class="hamburger-container">
                <div class="hamburger-wrapper">
                    <button class="hamburger-btn" onclick="toggleMenu()" id="hamburgerBtn">
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                    </button>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <button class="menu-item" onclick="openLogin()">Přihlásit se</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Desktop Calendar (Full Month) -->
        <div class="calendar-desktop" id="calendarDesktop">
            <div class="calendar-grid" id="calendarGrid">
                <!-- Desktop calendar will be generated by JavaScript -->
            </div>
        </div>

        <!-- Mobile Calendar (Scrollable Daily Cards) -->
        <div class="calendar-mobile" id="calendarMobile">
            <div class="daily-cards-container" id="dailyCardsContainer">
                <!-- Mobile daily cards will be generated by JavaScript -->
            </div>
        </div>
    </div>


    <!-- Login Modal -->
    <div class="modal-overlay" id="loginModal" onclick="closeModalOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeLoginModal()">×</button>
                <h2 class="modal-title">Přihlášení</h2>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label" for="username">Jméno</label>
                    <input type="text" id="username" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="password">Heslo</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="stayLoggedIn">
                    <label for="stayLoggedIn">Zůstat přihlášen</label>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">Přihlásit se</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal-overlay" id="addUserModal" onclick="closeModalOverlay(event, 'addUserModal')">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeAddUserModal()">×</button>
                <h2 class="modal-title">Přidat uživatele</h2>
            </div>
            <form onsubmit="handleAddUser(event)">
                <div class="form-group">
                    <label class="form-label" for="newUsername">Jméno</label>
                    <input type="text" id="newUsername" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="newPassword">Heslo</label>
                    <input type="password" id="newPassword" class="form-input" required>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">Přidat</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manage Users Modal -->
    <div class="modal-overlay" id="manageUsersModal" onclick="closeModalOverlay(event, 'manageUsersModal')">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeManageUsersModal()">×</button>
                <h2 class="modal-title">Správa uživatelů</h2>
            </div>
            <div class="user-list" id="userList">
                <!-- Users will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div class="modal-overlay" id="eventModal" onclick="closeModalOverlay(event, 'eventModal')">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeEventModal()">×</button>
                <h2 class="modal-title" id="eventModalTitle">Přidat událost</h2>
            </div>
            <form onsubmit="handleAddEvent(event)">
                <div class="form-group">
                    <label class="form-label" for="eventName">Název *</label>
                    <input type="text" id="eventName" class="form-input" required>
                </div>
                <div class="form-group" id="subjectGroup" style="display: none;">
                    <label class="form-label" for="eventSubject">Předmět *</label>
                    <select id="eventSubject" class="form-input" required>
                        <option value="">Vyberte předmět</option>
                        <option value="ICT">ICT</option>
                        <option value="DĚJ">DĚJ</option>
                        <option value="FYZ">FYZ</option>
                        <option value="ŠPJ">ŠPJ</option>
                        <option value="CJL">CJL</option>
                        <option value="ANJ">ANJ</option>
                        <option value="BIO">BIO</option>
                        <option value="MAT">MAT</option>
                        <option value="ESW">ESW</option>
                        <option value="ZSV">ZSV</option>
                        <option value="ZEM">ZEM</option>
                        <option value="UaK">UaK</option>
                        <option value="BEN">BEN</option>
                        <option value="CHEM">CHEM</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="eventDate">Datum *</label>
                    <input type="date" id="eventDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="eventDescription">Popis</label>
                    <textarea id="eventDescription" class="form-input" rows="3" placeholder="Volitelný popis události..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Příloha</label>
                    <div class="file-upload-area" onclick="document.getElementById('eventFile').click()" ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)">
                        <div class="file-upload-text">Klikněte nebo přetáhněte soubor</div>
                        <div class="file-upload-text" style="font-size: 12px; margin-top: 4px;">Podporované: obrázky, PDF, DOCX, PPTX</div>
                        <div id="fileSelectedInfo" class="file-selected" style="display: none;"></div>
                    </div>
                    <input type="file" id="eventFile" style="display: none;" accept="image/*,.pdf,.docx,.pptx" onchange="handleFileSelect(event)">
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">Přidat</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Event Detail Modal -->
    <div class="modal-overlay" id="eventDetailModal" onclick="closeModalOverlay(event, 'eventDetailModal')">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" onclick="closeEventDetailModal()">×</button>
                <h2 class="modal-title" id="eventDetailTitle">Detail události</h2>
            </div>
            <div id="eventDetailContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Smart Today Button -->
    <button class="today-button" id="todayButton"></button>

    <script>
        // Global variables
        let currentDate = new Date();
        let currentUser = null;
        let currentEventType = null;
        let selectedFile = null;

        // GitHub shared data storage
        let events = {};
        let users = {};
        let isDataLoaded = false;

        // GitHub API configuration
        const GITHUB_REPO = 'skibidiandulka/czech-homework-calendar';
        const GITHUB_DATA_URL = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/data.json`;

        // Hidden token function to prevent F12 inspection
        let GITHUB_TOKEN = null;
        function getApiToken() {
            if (!GITHUB_TOKEN) {
                // Obfuscated token parts - harder to find in DevTools
                const a = 'ghp_v8eJ', b = 'xR71yooA', c = 'lX0ug4VW', d = 'cjE0oJWH', e = 'Ew3v2YtH';
                GITHUB_TOKEN = [a,b,c,d,e].join('');
            }
            return GITHUB_TOKEN;
        }

        async function loadDataFromDatabase() {
            try {
                console.log('Loading data from GitHub...');
                const response = await fetch(GITHUB_DATA_URL + '?cache=' + Date.now());
                const data = await response.json();

                events = data?.events || {};
                users = data?.users || {};
                isDataLoaded = true;

                console.log('Data loaded successfully from GitHub:', { events, users });

                // Re-render calendar after data loads
                if (window.innerWidth <= 768) {
                    renderMobileCalendar();
                } else {
                    renderDesktopCalendar();
                }

                return true;
            } catch (error) {
                console.error('Failed to load data from GitHub:', error);
                // Fallback to default admin user
                users = {
                    'admin': {
                        password: 'asdf',
                        name: 'Admin',
                        tier: 'admin'
                    }
                };
                events = {};
                isDataLoaded = true;
                return false;
            }
        }

        async function saveFileToGitHub(file, eventId) {
            try {
                const token = getApiToken();
                if (!token) return null;

                // Create file path in attachments folder
                const fileName = `${eventId}_${file.name}`;
                const filePath = `attachments/${fileName}`;

                // Convert data URL to base64 content only
                const base64Content = file.data.split(',')[1];

                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${filePath}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: `Add attachment: ${file.name}`,
                        content: base64Content
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ File uploaded to GitHub:', fileName);
                    return {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        githubPath: filePath,
                        downloadUrl: result.content.download_url
                    };
                } else {
                    console.log('⚠️ File upload failed:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('Failed to upload file:', error);
                return null;
            }
        }

        async function saveDataToDatabase() {
            try {
                // Check if online
                if (!navigator.onLine) {
                    console.log('📴 Device is offline, saving locally only');
                    const data = {
                        events,
                        users,
                        lastUpdated: new Date().toISOString()
                    };
                    localStorage.setItem('calendar_backup', JSON.stringify(data));
                    return true;
                }

                // Get token securely
                const token = getApiToken();
                if (!token) {
                    console.log('⚠️ No GitHub token available, saving locally only');
                    const data = {
                        events,
                        users,
                        lastUpdated: new Date().toISOString()
                    };
                    localStorage.setItem('calendar_backup', JSON.stringify(data));
                    return true;
                }

                console.log('🔄 Syncing data to GitHub...');
                const data = {
                    events,
                    users,
                    lastUpdated: new Date().toISOString()
                };

                // Get current file SHA first
                const sha = await getFileShaSafe();
                if (!sha) {
                    console.log('⚠️ Could not get file SHA, probably network issue. Saving locally only.');
                    localStorage.setItem('calendar_backup', JSON.stringify(data));
                    console.log('💾 Data saved locally as backup');
                    return true; // Don't fail, just save locally
                }

                // Update data.json via GitHub API
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/data.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: 'Auto-sync calendar data',
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2)))), // UTF-8 safe Base64 encode
                        sha: sha
                    })
                });

                if (response.ok) {
                    console.log('✅ Data automatically synced to GitHub');
                    return true;
                } else {
                    console.log('⚠️ GitHub API failed:', response.status);

                    // If unauthorized, clear token
                    if (response.status === 401 || response.status === 403) {
                        GITHUB_TOKEN = null;
                        console.log('❌ GitHub API unauthorized');
                    }

                    // Fallback to localStorage
                    localStorage.setItem('calendar_backup', JSON.stringify(data));
                    console.log('💾 Data saved locally as backup');
                    return true;
                }
            } catch (error) {
                console.error('Failed to save data to GitHub:', error);

                // Always save to localStorage as backup
                const data = {
                    events,
                    users,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('calendar_backup', JSON.stringify(data));

                console.log('💾 Data saved locally as backup');
                return false;
            }
        }

        async function getFileShaSafe(retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const token = getApiToken();
                    const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/data.json`, {
                        headers: {
                            'Authorization': `token ${token}`,
                        }
                    });
                    if (response.ok) {
                        const fileData = await response.json();
                        return fileData.sha;
                    } else {
                        console.log(`⚠️ Get SHA attempt ${i + 1} failed:`, response.status);
                        if (i === retries - 1) return null;
                    }
                } catch (error) {
                    console.log(`⚠️ Get SHA attempt ${i + 1} failed:`, error.message);
                    if (i === retries - 1) {
                        console.log('❌ All retry attempts failed, saving locally only');
                        return null;
                    }
                    // Wait before retry
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            return null;
        }

        // Auto-save functions - save immediately without user interaction
        async function autoSave() {
            try {
                const success = await saveDataToDatabase();
                if (success) {
                    // Reload fresh data from GitHub after successful save
                    await loadDataFromDatabase();
                }
            } catch (error) {
                console.log('Auto-save failed, data saved locally as backup');
            }
        }

        // Legacy function names - now auto-save
        function saveEvents() {
            autoSave();
            return true;
        }

        function saveUsers() {
            autoSave();
            return true;
        }

        // Czech month and day names
        const monthNames = [
            'Leden', 'Únor', 'Březen', 'Duben', 'Květen', 'Červen',
            'Červenec', 'Srpen', 'Září', 'Říjen', 'Listopad', 'Prosinec'
        ];

        const dayNames = ['Neděle', 'Pondělí', 'Úterý', 'Středa', 'Čtvrtek', 'Pátek', 'Sobota'];
        const dayNamesShort = ['Ne', 'Po', 'Út', 'St', 'Čt', 'Pá', 'So'];

        // Initialize calendar
        function init() {
            renderCalendar();
        }

        // Main render function
        function renderCalendar() {
            renderDesktopCalendar();
            renderMobileCalendar();
            updateMonthTitle();
        }

        // Update month title
        function updateMonthTitle() {
            const monthTitle = document.getElementById('monthTitle');
            monthTitle.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        }

        // Desktop calendar renderer
        function renderDesktopCalendar() {
            const grid = document.getElementById('calendarGrid');

            // Create calendar grid
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let html = '';

            // Day headers
            dayNamesShort.forEach(day => {
                html += `<div class="day-header">${day}</div>`;
            });

            // Calendar days
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);

                let classes = 'calendar-day';
                if (date.getMonth() !== currentDate.getMonth()) {
                    classes += ' other-month';
                }
                if (date.getTime() === today.getTime()) {
                    classes += ' today';
                }

                html += `<div class="${classes}">`;
                html += `<div class="day-number">${date.getDate()}</div>`;
                html += '<div class="day-events">';

                const dateStr = formatDate(date);
                const dayEvents = events[dateStr] || [];
                dayEvents.forEach(event => {
                    const displayName = event.subject ? `${event.subject} - ${event.name}` : event.name;
                    html += `<div class="event-item ${event.type}" onclick="showEventDetail('${event.id}')">${displayName}</div>`;
                });

                html += '</div></div>';
            }

            grid.innerHTML = html;
        }

        // Mobile calendar with complete day list and smart header
        let todayCardPosition = 0;

        function renderMobileCalendar() {
            const container = document.getElementById('dailyCardsContainer');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const now = new Date();
            let allDays = [];

            // Add 15 previous days
            for (let i = 15; i >= 1; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                allDays.push(date);
            }

            // Add today and future days in current month
            if (currentDate.getMonth() === now.getMonth() && currentDate.getFullYear() === now.getFullYear()) {
                // Current month - start from today
                const startDate = new Date(now);
                startDate.setHours(0, 0, 0, 0);
                const endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);

                for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
                    allDays.push(new Date(date));
                }

                // Add 7 days from next month
                const nextMonthStart = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
                for (let i = 0; i < 7; i++) {
                    const nextMonthDate = new Date(nextMonthStart);
                    nextMonthDate.setDate(nextMonthDate.getDate() + i);
                    allDays.push(nextMonthDate);
                }
            } else {
                // Other month - all days in month
                const startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);

                for (let date = new Date(startDate); date <= endDate; date.setDate(date.getDate() + 1)) {
                    allDays.push(new Date(date));
                }

                // Add 7 days from next month
                const nextMonthStart = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
                for (let i = 0; i < 7; i++) {
                    const nextMonthDate = new Date(nextMonthStart);
                    nextMonthDate.setDate(nextMonthDate.getDate() + i);
                    allDays.push(nextMonthDate);
                }
            }

            renderAllDays(container, allDays, today);
            setupSmartHeaderBehavior(today);

            // Scroll to today after rendering
            setTimeout(() => {
                scrollToToday();
            }, 100);
        }

        function renderAllDays(container, days, today) {
            let html = '';
            let previousMonth = null;

            days.forEach((date, index) => {
                const isToday = date.getTime() === today.getTime();

                if (isToday) {
                    todayCardPosition = index;
                }

                // Check if we're starting a new month and add separator
                if (previousMonth !== null && date.getMonth() !== previousMonth) {
                    const monthName = monthNames[date.getMonth()];
                    html += `<div class="month-separator"><div class="separator-line"></div><div class="separator-text">${monthName}</div></div>`;
                }

                previousMonth = date.getMonth();

                html += `<div class="daily-card${isToday ? ' today' : ''}" data-index="${index}">`;
                html += '<div class="daily-card-header">';
                html += '<div class="daily-card-date-info">';
                html += `<div class="daily-card-date">${date.getDate()}</div>`;
                html += `<div class="daily-card-day">${dayNames[date.getDay()]}</div>`;
                html += '</div>';
                html += `<div class="daily-card-badge">${isToday ? 'Dnes' : monthNames[date.getMonth()].slice(0, 3)}</div>`;
                html += '</div>';

                const dateStr = formatDate(date);
                const dayEvents = events[dateStr] || [];

                // Debug events for tomorrow
                if (date.getDate() === today.getDate() + 1) {
                    console.log('Tomorrow events debug:', {
                        date: dateStr,
                        dayEvents,
                        allEvents: events
                    });
                }

                if (dayEvents.length > 0) {
                    html += '<div class="daily-card-events">';
                    dayEvents.forEach(event => {
                        const displayName = event.subject ? `${event.subject} - ${event.name}` : event.name;
                        html += `<div class="event-item ${event.type}" onclick="showEventDetail('${event.id}')">${displayName}</div>`;
                    });
                    html += '</div>';
                } else {
                    html += '<div class="daily-card-empty">Žádné události</div>';
                }

                html += '</div>';
            });

            container.innerHTML = html;
        }

        function scrollToToday() {
            const todayCard = document.querySelector('.daily-card.today');
            if (todayCard) {
                todayCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Make scrollToToday globally available
        window.scrollToToday = scrollToToday;

        function setupSmartHeaderBehavior(today) {
            setupTodayButtonBehavior();
        }

        function scrollToTodayFirst() {
            const todayCard = document.querySelector('.daily-card.today');
            if (!todayCard) {
                alert('Dnešní den nenalezen!');
                return;
            }

            // Simple robust scroll - always account for potential header space
            const offsetTop = todayCard.offsetTop - 100; // 100px buffer for header + padding

            window.scrollTo({
                top: Math.max(0, offsetTop),
                behavior: 'smooth'
            });

            // Force hide button immediately (it will reappear if needed)
            const todayButton = document.getElementById('todayButton');
            todayButton.classList.remove('show', 'direction-up', 'direction-down');
        }

        function setupTodayButtonBehavior() {
            const todayButton = document.getElementById('todayButton');
            let ticking = false;

            // Add click event listener
            todayButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                scrollToTodayFirst();
            });

            function updateTodayButton() {
                try {
                    const header = document.querySelector('.calendar-header');
                    const todayCard = document.querySelector('.daily-card.today');

                    if (!todayCard || !header) {
                        todayButton.classList.remove('show', 'direction-up', 'direction-down');
                        ticking = false;
                        return;
                    }

                    // Check if header is visible first - iPhone compatible method
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const headerRect = header.getBoundingClientRect();
                    const isHeaderVisible = headerRect.bottom > 0;

                    // Debug for iPhone
                    if (Math.random() < 0.01) { // Log only occasionally to avoid spam
                        console.log('Header visibility:', {
                            scrollTop,
                            headerBottom: headerRect.bottom,
                            isHeaderVisible
                        });
                    }

                    // If header is not visible, hide the today button
                    if (!isHeaderVisible) {
                        todayButton.classList.remove('show', 'direction-up', 'direction-down');
                        ticking = false;
                        return;
                    }

                    // Header is visible, now check today card visibility
                    const viewportHeight = window.innerHeight;
                    const cardOffsetTop = todayCard.offsetTop;
                    const cardHeight = todayCard.offsetHeight;

                    // Calculate visible area
                    const cardScreenTop = cardOffsetTop - scrollTop;
                    const cardScreenBottom = cardScreenTop + cardHeight;

                    // Simple visibility check
                    const isVisible = cardScreenTop < viewportHeight && cardScreenBottom > 0;

                    if (isVisible) {
                        // Today is visible - hide button
                        todayButton.classList.remove('show', 'direction-up', 'direction-down');
                    } else {
                        // Today is not visible but header is visible - show button
                        todayButton.classList.add('show');
                        todayButton.classList.remove('direction-up', 'direction-down');

                        if (cardScreenBottom <= 0) {
                            // Today is above screen
                            todayButton.classList.add('direction-up');
                        } else {
                            // Today is below screen
                            todayButton.classList.add('direction-down');
                        }
                    }
                } catch (e) {
                    // Fallback - just show button pointing down
                    todayButton.classList.add('show', 'direction-down');
                    todayButton.classList.remove('direction-up');
                }

                ticking = false;
            }

            function requestTick() {
                if (!ticking) {
                    requestAnimationFrame(updateTodayButton);
                    ticking = true;
                }
            }

            window.addEventListener('scroll', requestTick, { passive: true });
            window.addEventListener('resize', requestTick, { passive: true });

            // Initial check with delay
            setTimeout(updateTodayButton, 300);
        }

        // Event detail functions
        function showEventDetail(eventId) {
            const event = findEventById(eventId);
            if (!event) return;

            const modal = document.getElementById('eventDetailModal');
            const title = document.getElementById('eventDetailTitle');
            const content = document.getElementById('eventDetailContent');

            const typeNames = {
                'test': 'Test',
                'homework': 'Domácí úkol',
                'other': 'Jiné'
            };

            title.textContent = event.name;

            let html = `
                <div style="padding: 20px;">
                    <div style="margin-bottom: 16px;">
                        <strong>Typ:</strong> ${typeNames[event.type]}
                    </div>
                    ${event.subject ? `
                        <div style="margin-bottom: 16px;">
                            <strong>Předmět:</strong> ${event.subject}
                        </div>
                    ` : ''}
                    <div style="margin-bottom: 16px;">
                        <strong>Datum:</strong> ${new Date(event.date).toLocaleDateString('cs-CZ')}
                    </div>
                    ${event.description ? `
                        <div style="margin-bottom: 16px;">
                            <strong>Popis:</strong><br>
                            <div style="margin-top: 8px; padding: 12px; background: var(--anthropic-warm-white); border-radius: var(--small-radius);">
                                ${event.description}
                            </div>
                        </div>
                    ` : ''}
                    ${event.file ? `
                        <div style="margin-bottom: 16px;">
                            <strong>Příloha:</strong><br>
                            <div style="margin-top: 8px;">
                                <a href="${event.file.data}" download="${event.file.name}"
                                   style="display: inline-block; padding: 8px 12px; background: var(--anthropic-coral-light);
                                          color: var(--anthropic-coral); text-decoration: none; border-radius: var(--small-radius);
                                          font-weight: 500;">
                                    📎 ${event.file.name}
                                </a>
                            </div>
                        </div>
                    ` : ''}
                    <div style="font-size: 12px; color: var(--anthropic-text-secondary); margin-top: 20px;">
                        Vytvořil: ${event.createdBy} • ${new Date(event.createdAt).toLocaleString('cs-CZ')}
                    </div>
                    ${(currentUser && currentUser.tier !== 'blocked' &&
                       (currentUser.tier === 'admin' || currentUser.username === event.createdBy)) ? `
                        <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--anthropic-border-light); text-align: right;">
                            <button onclick="deleteEvent('${event.id}')"
                                    style="padding: 8px 16px; background: rgba(220, 53, 69, 0.1); color: #dc3545;
                                           border: 1px solid rgba(220, 53, 69, 0.3); border-radius: var(--small-radius);
                                           cursor: pointer; font-weight: 500; transition: all 0.15s ease;"
                                    onmouseover="this.style.background='rgba(220, 53, 69, 0.2)'"
                                    onmouseout="this.style.background='rgba(220, 53, 69, 0.1)'">
                                Smazat událost
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;

            content.innerHTML = html;
            modal.classList.add('show');
        }

        function closeEventDetailModal() {
            closeModal('eventDetailModal');
        }

        async function deleteEvent(eventId) {
            if (!confirm('Opravdu chcete smazat tuto událost?')) {
                return;
            }

            // Find and remove the event
            for (const date in events) {
                const eventIndex = events[date].findIndex(e => e.id === eventId);
                if (eventIndex !== -1) {
                    events[date].splice(eventIndex, 1);
                    // Remove the date key if no events left for that day
                    if (events[date].length === 0) {
                        delete events[date];
                    }
                    break;
                }
            }

            await autoSave(); // Wait for save to complete
            renderCalendar(); // Re-render after save is done
            closeEventDetailModal();
        }

        function findEventById(eventId) {
            for (const date in events) {
                const event = events[date].find(e => e.id === eventId);
                if (event) return event;
            }
            return null;
        }

        function formatDate(date) {
            // Use local timezone instead of UTC to avoid date offset issues
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Navigation functions
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }


        // Dropdown menu functions
        function openMenu() {
            document.getElementById('dropdownMenu').classList.add('show');
            document.getElementById('hamburgerBtn').classList.add('active');
        }

        function closeMenu() {
            document.getElementById('dropdownMenu').classList.remove('show');
            document.getElementById('hamburgerBtn').classList.remove('active');
        }

        function toggleMenu() {
            const menu = document.getElementById('dropdownMenu');
            if (menu.classList.contains('show')) {
                closeMenu();
            } else {
                openMenu();
            }
        }

        function openLogin() {
            closeMenu();
            document.getElementById('loginModal').classList.add('show');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('hiding');
            modal.classList.remove('show');

            setTimeout(() => {
                modal.classList.remove('hiding');
            }, 300);
        }

        function closeLoginModal() {
            closeModal('loginModal');
        }

        function closeModalOverlay(event, modalId = 'loginModal') {
            if (event.target === event.currentTarget) {
                closeModal(modalId);
            }
        }

        // Add User Modal Functions
        function openAddUserModal() {
            closeMenu();
            document.getElementById('addUserModal').classList.add('show');
        }

        function closeAddUserModal() {
            closeModal('addUserModal');
        }

        async function handleAddUser(event) {
            event.preventDefault();

            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;

            if (users[username]) {
                alert('Uživatel s tímto jménem již existuje');
                return;
            }

            users[username] = {
                password: password,
                name: username.charAt(0).toUpperCase() + username.slice(1),
                tier: 'basic'
            };

            await autoSave(); // Wait for save to complete
            renderUserList(); // Refresh user list to show new user
            closeAddUserModal();

            // Clear form
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';

            alert(`Uživatel ${username} byl úspěšně přidán`);
        }

        // Event modal functions
        function openEventModal(type) {
            closeMenu();
            currentEventType = type;

            const titles = {
                'test': 'Přidat test',
                'homework': 'Přidat domácí úkol',
                'other': 'Přidat jiné'
            };

            document.getElementById('eventModalTitle').textContent = titles[type];

            // Show/hide subject field based on event type
            const subjectGroup = document.getElementById('subjectGroup');
            const subjectField = document.getElementById('eventSubject');

            if (type === 'homework' || type === 'test') {
                subjectGroup.style.display = 'block';
                subjectField.required = true;
            } else {
                subjectGroup.style.display = 'none';
                subjectField.required = false;
                subjectField.value = '';
            }

            document.getElementById('eventModal').classList.add('show');

            // Set date constraints and default value
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const maxDate = new Date(today.getFullYear() + 5, today.getMonth(), today.getDate());
            const maxDateStr = maxDate.toISOString().split('T')[0];

            const dateInput = document.getElementById('eventDate');
            dateInput.min = todayStr;
            dateInput.max = maxDateStr;
            dateInput.value = todayStr;
        }

        function closeEventModal() {
            closeModal('eventModal');
            clearEventForm();
        }

        function clearEventForm() {
            document.getElementById('eventName').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventSubject').value = '';
            document.getElementById('eventFile').value = '';
            document.getElementById('fileSelectedInfo').style.display = 'none';
            selectedFile = null;
        }

        async function handleAddEvent(event) {
            event.preventDefault();

            const name = document.getElementById('eventName').value;
            const date = document.getElementById('eventDate').value;
            const description = document.getElementById('eventDescription').value;
            const subject = document.getElementById('eventSubject').value;

            const eventId = Date.now().toString();
            let fileAttachment = null;

            // Upload file to GitHub if selected
            if (selectedFile) {
                console.log('📎 Uploading attachment...');
                fileAttachment = await saveFileToGitHub(selectedFile, eventId);
                if (fileAttachment) {
                    console.log('✅ Attachment uploaded successfully');
                } else {
                    console.log('⚠️ Attachment upload failed, saving file data locally');
                    fileAttachment = selectedFile; // Keep local copy as fallback
                }
            }

            const newEvent = {
                id: eventId,
                name: name,
                type: currentEventType,
                date: date,
                description: description,
                subject: subject || null,
                file: fileAttachment,
                createdBy: currentUser.username,
                createdAt: new Date().toISOString()
            };

            if (!events[date]) {
                events[date] = [];
            }

            events[date].push(newEvent);
            await autoSave(); // Wait for save to complete
            renderCalendar(); // Re-render after save is done
            closeEventModal();

            return false;
        }

        // File handling functions
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedFile = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result
                    };
                    document.getElementById('fileSelectedInfo').textContent = `Soubor: ${file.name}`;
                    document.getElementById('fileSelectedInfo').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                const fileInput = document.getElementById('eventFile');
                fileInput.files = files;
                handleFileSelect({ target: { files: [file] } });
            }
        }

        // Manage Users Modal Functions
        function openManageUsersModal() {
            closeMenu();
            renderUserList();
            document.getElementById('manageUsersModal').classList.add('show');
        }

        function closeManageUsersModal() {
            closeModal('manageUsersModal');
        }

        function renderUserList() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';

            Object.keys(users).forEach(username => {
                const user = users[username];
                const userItem = document.createElement('div');
                userItem.className = 'user-item';

                userItem.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">${user.name}</div>
                        <span class="user-tier ${user.tier}">${user.tier}</span>
                    </div>
                    <div class="user-actions">
                        ${username !== 'admin' ? `
                            ${user.tier === 'basic' ?
                                `<button class="btn-small" onclick="changeUserTier('${username}', 'admin')">Povýšit na Admin</button>` :
                                user.tier === 'admin' ?
                                    `<button class="btn-small" onclick="changeUserTier('${username}', 'basic')">Degradovat na Basic</button>` : ''
                            }
                            ${user.tier !== 'blocked' ?
                                `<button class="btn-small" onclick="changeUserTier('${username}', 'blocked')" style="background: rgba(220, 53, 69, 0.1); color: #dc3545;">Zablokovat</button>` :
                                `<button class="btn-small" onclick="changeUserTier('${username}', 'basic')" style="background: var(--anthropic-coral-light); color: var(--anthropic-coral);">Odblokovat</button>`
                            }
                        ` : ''}
                    </div>
                `;

                userList.appendChild(userItem);
            });
        }

        async function changeUserTier(username, newTier) {
            if (username === 'admin' && newTier === 'basic') {
                alert('Hlavního admina nelze degradovat');
                return;
            }

            users[username].tier = newTier;
            await autoSave(); // Wait for save to complete
            renderUserList(); // Re-render after save is done

            // If the current user's tier was changed, update their menu
            if (currentUser && currentUser.username === username) {
                currentUser.tier = newTier;
                if (newTier === 'basic') {
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
                updateMenuForLoggedUser();
            }
        }

        function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const stayLoggedIn = document.getElementById('stayLoggedIn').checked;

            // Debug info for mobile
            console.log('Login attempt:', { username, password, availableUsers: Object.keys(users) });

            // Find user by case-insensitive username
            const userKey = Object.keys(users).find(key => key.toLowerCase() === username.toLowerCase());

            console.log('Found user key:', userKey);

            if (userKey) {
                const storedPassword = users[userKey].password;
                console.log('Password comparison:', {
                    entered: password,
                    enteredLower: password.toLowerCase(),
                    stored: storedPassword,
                    storedLower: storedPassword.toLowerCase(),
                    match: storedPassword.toLowerCase() === password.toLowerCase()
                });
            }

            if (userKey && users[userKey].password.toLowerCase() === password.toLowerCase()) {
                currentUser = {
                    username: userKey,
                    name: users[userKey].name,
                    tier: users[userKey].tier
                };

                if (stayLoggedIn) {
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }

                updateMenuForLoggedUser();
                closeLoginModal();

                // Clear form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('stayLoggedIn').checked = false;

                console.log('Login successful:', currentUser);
            } else {
                console.log('Login failed - user or password incorrect');
                alert('Nesprávné jméno nebo heslo');
            }
        }

        function updateMenuForLoggedUser() {
            const dropdownMenu = document.getElementById('dropdownMenu');

            if (currentUser.tier === 'blocked') {
                dropdownMenu.innerHTML = `
                    <button class="menu-item blocked" onclick="return false;">Přidat test</button>
                    <button class="menu-item blocked" onclick="return false;">Přidat domácí úkol</button>
                    <button class="menu-item blocked" onclick="return false;">Přidat jiné</button>
                    <div class="menu-separator"></div>
                    <button class="menu-item logout" onclick="logout()">Odhlásit se</button>
                `;
            } else if (currentUser.tier === 'admin') {
                dropdownMenu.innerHTML = `
                    <button class="menu-item" onclick="openEventModal('test')">Přidat test</button>
                    <button class="menu-item" onclick="openEventModal('homework')">Přidat domácí úkol</button>
                    <button class="menu-item" onclick="openEventModal('other')">Přidat jiné</button>
                    <div class="menu-separator"></div>
                    <button class="menu-item" onclick="openAddUserModal()">Přidat uživatele</button>
                    <button class="menu-item" onclick="openManageUsersModal()">Správa uživatelů</button>
                    <div class="menu-separator"></div>
                    <button class="menu-item logout" onclick="logout()">Odhlásit se</button>
                `;
            } else { // basic
                dropdownMenu.innerHTML = `
                    <button class="menu-item" onclick="openEventModal('test')">Přidat test</button>
                    <button class="menu-item" onclick="openEventModal('homework')">Přidat domácí úkol</button>
                    <button class="menu-item" onclick="openEventModal('other')">Přidat jiné</button>
                    <div class="menu-separator"></div>
                    <button class="menu-item logout" onclick="logout()">Odhlásit se</button>
                `;
            }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');

            const dropdownMenu = document.getElementById('dropdownMenu');
            dropdownMenu.innerHTML = '<button class="menu-item" onclick="openLogin()">Přihlásit se</button>';

            closeMenu();
        }

        function checkStoredLogin() {
            const stored = localStorage.getItem('currentUser');
            if (stored) {
                currentUser = JSON.parse(stored);
                updateMenuForLoggedUser();
            }
        }


        // Close menu with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeMenu();
                closeLoginModal();
                closeAddUserModal();
                closeManageUsersModal();
                closeEventModal();
                closeEventDetailModal();
            }
        });

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const hamburgerWrapper = document.querySelector('.hamburger-wrapper');
            if (!hamburgerWrapper.contains(event.target)) {
                closeMenu();
            }
        });

        // Initialize when page loads
        window.onload = async function() {
            console.log('=== INITIALIZING CALENDAR ===');
            console.log('Screen width:', window.innerWidth);

            // Load data from database first
            await loadDataFromDatabase();

            console.log('=== DEBUG INFO ===');
            console.log('Users data:', users);
            console.log('Events data:', events);
            console.log('Data loaded:', isDataLoaded);
            console.log('==============================');

            init();
            checkStoredLogin();
        };
    </script>
</body>
</html>